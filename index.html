<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Tokeji ‚ú®</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
  <meta name="theme-color" content="#FF6B9D"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      -webkit-touch-callout: none;
    }

    :root {
      --device-color: #FF6B9D;
      --device-dark: #FF4785;
      --device-light: #FFB8D0;
      --center-bg: #FFF5F7;
      --up-bg: linear-gradient(180deg, #E8F4FF 0%, #B8D4F0 100%);
      --down-bg: linear-gradient(180deg, #F0FFF4 0%, #B8E6C1 100%);
      --left-bg: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
      --right-bg: linear-gradient(135deg, #ff6b35 0%, #f7931e 35%, #ff00a0 70%, #ff0000 100%);
      --transition-speed: 0.5s;
    }

    html, body {
      touch-action: pan-x pan-y;
      -webkit-text-size-adjust: 100%;
      overflow: hidden;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
      font-family: 'Nunito', sans-serif;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    .device {
      width: 340px;
      height: 600px;
      background: linear-gradient(145deg, var(--device-light) 0%, var(--device-color) 50%, var(--device-dark) 100%);
      border-radius: 40px;
      padding: 25px 15px 15px 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      position: relative;
      display: flex;
      flex-direction: column;
      border: 3px solid rgba(255,255,255,0.2);
      transform: translateZ(0);
      margin: auto;
    }

    .screw {
      position: absolute;
      width: 12px;
      height: 12px;
      background: linear-gradient(145deg, #E8E8E8, #A0A0A0);
      border-radius: 50%;
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.3);
      z-index: 10;
    }

    .screw::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      width: 6px;
      height: 2px;
      background: #666;
      box-shadow: 0 0 0 1px #666;
    }

    .screw-tl { top: 12px; left: 15px; }
    .screw-tr { top: 12px; right: 15px; }
    .screw-bl { bottom: 100px; left: 15px; }
    .screw-br { bottom: 100px; right: 15px; }

    .device-logo {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Fredoka One', cursive;
      font-size: 11px;
      color: rgba(255,255,255,0.9);
      letter-spacing: 2px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 5;
    }

    .shine {
      position: absolute;
      top: 15px;
      left: 20%;
      right: 20%;
      height: 25%;
      background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, transparent 100%);
      border-radius: 50% 50% 0 0;
      pointer-events: none;
    }

    .screen-container {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 8px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
    }

    .screen {
      width: 100%;
      height: 380px;
      background: var(--center-bg);
      border-radius: 22px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
      border: 4px solid #2D3748;
      display: flex;
      flex-direction: column;
      transition: all var(--transition-speed) cubic-bezier(0.4, 0.0, 0.2, 1);
      will-change: transform, background;
    }

    /* Estados de zona */
    .screen.zone-center {
      background: var(--center-bg);
      transform: scale(1);
    }

    .screen.zone-up {
      background: var(--up-bg);
      transform: scale(0.95) translateY(-5%);
    }

    .screen.zone-down {
      background: var(--down-bg);
      transform: scale(0.95) translateY(5%);
    }

    .screen.zone-left {
      background: var(--left-bg);
      transform: scale(0.95) translateX(-5%);
    }

    .screen.zone-right {
      background: var(--right-bg);
      transform: scale(0.95) translateX(5%);
      background-size: 220% 220%;
      animation: gasGradient 8s ease infinite;
    }

    @keyframes gasGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .status-bar {
      position: absolute;
      top: 8px;
      left: 12px;
      right: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      font-weight: 800;
      color: #718096;
      z-index: 10;
      font-family: 'Fredoka One', cursive;
      transition: color 0.3s;
    }

    .screen.zone-left .status-bar,
    .screen.zone-right .status-bar {
      color: rgba(255,255,255,0.9);
    }

    .content {
      flex: 1;
      position: relative;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }

    /* ZONAS - Contenedores absolutos */
    .zone {
      position: absolute;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity var(--transition-speed), transform var(--transition-speed);
      transform: scale(0.9);
    }

    .zone.active {
      display: flex;
      opacity: 1;
      transform: scale(1);
    }

    /* ZONA CENTRO - YO */
    .zone-center {
      background: transparent;
    }

    .center-avatar {
      font-size: 80px;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.15));
      animation: float 3s ease-in-out infinite, breathe 4s ease-in-out infinite;
      cursor: pointer;
      transition: transform 0.3s;
      position: relative;
      z-index: 5;
    }

    .center-avatar:hover {
      transform: scale(1.1);
    }

    .center-avatar.bored {
      animation: bored 5s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }

    @keyframes breathe {
      0%, 100% { filter: drop-shadow(0 8px 16px rgba(0,0,0,0.15)); }
      50% { filter: drop-shadow(0 12px 24px rgba(255,107,157,0.4)); }
    }

    @keyframes bored {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-5deg) translateY(5px); }
      75% { transform: rotate(5deg) translateY(5px); }
    }

    .center-name {
      font-family: 'Fredoka One', cursive;
      font-size: 24px;
      color: #2D3748;
      margin-top: 15px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .center-status {
      font-size: 12px;
      padding: 6px 16px;
      border-radius: 20px;
      font-weight: 800;
      color: white;
      margin-top: 10px;
      box-shadow: 0 3px 0 rgba(0,0,0,0.2);
      transition: all 0.3s;
      cursor: pointer;
    }

    .center-status.disponible { background: #48BB78; box-shadow: 0 3px 0 #2F855A; }
    .center-status.ocupado { background: #F56565; box-shadow: 0 3px 0 #C53030; }
    .center-status.ausente { background: #ECC94B; box-shadow: 0 3px 0 #B7791F; color: #744210; }

    .center-stats {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      font-size: 11px;
      font-weight: 700;
      color: #4A5568;
    }

    .center-stat {
      background: rgba(255,255,255,0.8);
      padding: 6px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Indicadores de zona */
    .zone-indicator {
      position: absolute;
      font-size: 24px;
      opacity: 0.3;
      transition: all 0.3s;
      animation: pulse-indicator 2s ease-in-out infinite;
    }

    .zone-indicator:hover, .zone-indicator.active {
      opacity: 1;
      transform: scale(1.2);
    }

    @keyframes pulse-indicator {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    .indicator-up { top: 15px; left: 50%; transform: translateX(-50%); }
    .indicator-down { bottom: 15px; left: 50%; transform: translateX(-50%); }
    .indicator-left { left: 15px; top: 50%; transform: translateY(-50%); }
    .indicator-right { right: 15px; top: 50%; transform: translateY(-50%); }

    /* ZONA ARRIBA - MURMULLO */
    .zone-up {
      background: var(--up-bg);
      padding: 20px;
    }

    .murmullo-sky {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .cloud {
      position: absolute;
      background: rgba(255,255,255,0.9);
      border-radius: 20px;
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 700;
      color: #2D3748;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 200px;
      animation: float-cloud 8s ease-in-out infinite;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .cloud.focused {
      border-color: #4299E1;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(66,153,225,0.4);
    }

    .cloud.golden {
      background: linear-gradient(145deg, #FFD93D, #F6AD55);
      color: #744210;
      animation: float-cloud 6s ease-in-out infinite, shimmer 2s ease-in-out infinite;
    }

    @keyframes float-cloud {
      0%, 100% { transform: translateY(0) translateX(0); }
      25% { transform: translateY(-10px) translateX(5px); }
      50% { transform: translateY(-5px) translateX(-5px); }
      75% { transform: translateY(-15px) translateX(3px); }
    }

    @keyframes shimmer {
      0%, 100% { box-shadow: 0 4px 15px rgba(255,217,61,0.4); }
      50% { box-shadow: 0 6px 25px rgba(255,217,61,0.8); }
    }

    /* ZONA ABAJO - CABLE */
    .zone-down {
      background: var(--down-bg);
      padding: 20px;
    }

    .cable-container {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cable-line {
      position: absolute;
      width: 80%;
      height: 4px;
      background: linear-gradient(90deg, transparent 0%, #48BB78 20%, #48BB78 80%, transparent 100%);
      box-shadow: 0 0 10px #48BB78;
      animation: cable-pulse 2s ease-in-out infinite;
    }

    @keyframes cable-pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; box-shadow: 0 0 20px #48BB78; }
    }

    .cable-node {
      position: absolute;
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-size: 28px;
      cursor: pointer;
      transition: all 0.3s;
      border: 3px solid transparent;
      z-index: 5;
    }

    .cable-node.focused {
      transform: scale(1.2);
      border-color: #48BB78;
      box-shadow: 0 0 0 4px rgba(72,187,120,0.3), 0 6px 20px rgba(0,0,0,0.3);
    }

    .cable-node .name {
      font-size: 9px;
      font-weight: 800;
      color: #2D3748;
      margin-top: 2px;
      max-width: 50px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .cable-node .streak {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #F56565;
      color: white;
      font-size: 10px;
      font-weight: 800;
      padding: 2px 6px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Rueda de emociones */
    .emotion-wheel {
      position: absolute;
      width: 200px;
      height: 200px;
      display: none;
      z-index: 20;
    }

    .emotion-wheel.active {
      display: block;
      animation: wheel-appear 0.3s ease;
    }

    @keyframes wheel-appear {
      from { transform: scale(0) rotate(-180deg); opacity: 0; }
      to { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .emotion-option {
      position: absolute;
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.2s;
      border: 3px solid transparent;
    }

    .emotion-option.focused {
      transform: scale(1.2);
      border-color: var(--device-color);
      box-shadow: 0 0 0 4px rgba(255,107,157,0.3);
    }

    .emotion-option:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); }
    .emotion-option:nth-child(2) { top: 50%; right: 0; transform: translateY(-50%); }
    .emotion-option:nth-child(3) { bottom: 0; left: 50%; transform: translateX(-50%); }
    .emotion-option:nth-child(4) { top: 50%; left: 0; transform: translateY(-50%); }

    /* ZONA IZQUIERDA - ARENA */
    .zone-left {
      background: var(--left-bg);
      padding: 20px;
      color: white;
    }

    .arena-title {
      font-family: 'Fredoka One', cursive;
      font-size: 22px;
      color: #FFD93D;
      text-shadow: 0 4px 8px rgba(0,0,0,0.5);
      margin-bottom: 20px;
    }

    .arena-modes {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
    }

    .arena-mode {
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 2px solid transparent;
      border-radius: 16px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .arena-mode.focused {
      border-color: #FFD93D;
      background: linear-gradient(145deg, rgba(255,217,61,0.2), rgba(255,217,61,0.1));
      transform: scale(1.02);
    }

    .arena-mode .icon {
      font-size: 32px;
    }

    .arena-mode .info {
      flex: 1;
    }

    .arena-mode .title {
      font-weight: 800;
      font-size: 14px;
    }

    .arena-mode .desc {
      font-size: 10px;
      opacity: 0.8;
      margin-top: 2px;
    }

    /* ZONA DERECHA - LLAMAS */
    .zone-right {
      padding: 20px;
      color: white;
    }

    .flames-tunnel {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .tunnel-modes {
      position: absolute;
      top: 10px;
      display: flex;
      gap: 10px;
      background: rgba(0,0,0,0.3);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
    }

    .tunnel-mode {
      padding: 4px 10px;
      border-radius: 12px;
      opacity: 0.6;
      transition: all 0.3s;
    }

    .tunnel-mode.active {
      opacity: 1;
      background: rgba(255,255,255,0.2);
    }

    .poll-card {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 20px;
      width: 100%;
      max-width: 260px;
      color: #2D3748;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: poll-glow 3s ease-in-out infinite;
    }

    @keyframes poll-glow {
      0%, 100% { box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
      50% { box-shadow: 0 15px 50px rgba(255,0,160,0.4); }
    }

    .poll-emoji {
      font-size: 40px;
      text-align: center;
      margin-bottom: 10px;
    }

    .poll-question {
      font-family: 'Fredoka One', cursive;
      font-size: 16px;
      text-align: center;
      line-height: 1.4;
      margin-bottom: 15px;
      background: linear-gradient(135deg, #ff6b35, #ff00a0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .poll-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .poll-option {
      background: #F7FAFC;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .poll-option.focused {
      border-color: #FF6B9D;
      background: #FFF5F7;
      transform: scale(1.05);
    }

    .poll-option .avatar {
      font-size: 24px;
      display: block;
      margin-bottom: 4px;
    }

    .poll-timer {
      text-align: center;
      margin-top: 15px;
      font-size: 11px;
      color: #718096;
      font-weight: 700;
    }

    /* Men√∫ Radial (Centro - OK largo) */
    .radial-menu {
      position: absolute;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }

    .radial-menu.active {
      display: flex;
      animation: fade-in 0.3s ease;
    }

    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .radial-center {
      position: absolute;
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 2;
    }

    .radial-item {
      position: absolute;
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s;
      border: 3px solid transparent;
    }

    .radial-item.focused {
      transform: scale(1.2);
      border-color: var(--device-color);
      box-shadow: 0 0 0 4px rgba(255,107,157,0.3), 0 6px 20px rgba(0,0,0,0.3);
    }

    .radial-item .label {
      position: absolute;
      bottom: -18px;
      font-size: 9px;
      font-weight: 800;
      color: #2D3748;
      white-space: nowrap;
    }

    /* Posiciones radiales */
    .radial-item:nth-child(1) { transform: translateY(-80px); }
    .radial-item:nth-child(2) { transform: translateX(80px); }
    .radial-item:nth-child(3) { transform: translateY(80px); }
    .radial-item:nth-child(4) { transform: translateX(-80px); }

    .radial-item.focused:nth-child(1) { transform: translateY(-80px) scale(1.2); }
    .radial-item.focused:nth-child(2) { transform: translateX(80px) scale(1.2); }
    .radial-item.focused:nth-child(3) { transform: translateY(80px) scale(1.2); }
    .radial-item.focused:nth-child(4) { transform: translateX(-80px) scale(1.2); }

    /* QR Overlay */
    .qr-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }

    .qr-overlay.active {
      display: flex;
      animation: zoom-in 0.3s ease;
    }

    @keyframes zoom-in {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .qr-container {
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .qr-hint {
      color: white;
      margin-top: 15px;
      font-size: 12px;
      text-align: center;
    }

    /* Lista de amigos (Cable - OK largo en vac√≠o) */
    .friends-list-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(240,255,244,0.98);
      display: none;
      flex-direction: column;
      z-index: 25;
      padding: 20px;
    }

    .friends-list-overlay.active {
      display: flex;
      animation: slide-up 0.3s ease;
    }

    @keyframes slide-up {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .friends-list-title {
      font-family: 'Fredoka One', cursive;
      font-size: 18px;
      color: #2D3748;
      margin-bottom: 15px;
      text-align: center;
    }

    .friends-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .friend-item {
      background: white;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .friend-item.focused {
      border-color: #48BB78;
      background: #F0FFF4;
      transform: translateX(5px);
    }

    /* Controles */
    .controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 15;
      margin-top: -5px;
    }

    .dpad-circle {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: linear-gradient(145deg, 
        rgba(255,255,255,0.4) 0%, 
        rgba(255,255,255,0.1) 50%,
        rgba(0,0,0,0.1) 100%);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.2),
        inset 0 1px 3px rgba(255,255,255,0.5),
        inset 0 -2px 4px rgba(0,0,0,0.1);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .nav-ring {
      width: 92px;
      height: 92px;
      border-radius: 50%;
      background: linear-gradient(145deg, 
        var(--device-light) 0%, 
        var(--device-color) 60%, 
        var(--device-dark) 100%);
      box-shadow: 
        inset 0 2px 5px rgba(0,0,0,0.15),
        0 1px 3px rgba(255,255,255,0.3);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .nav-sector {
      position: absolute;
      width: 50%;
      height: 50%;
      cursor: pointer;
      z-index: 5;
      transition: all 0.05s ease;
    }

    .nav-sector:active {
      background: rgba(0,0,0,0.15);
    }

    .sector-up {
      top: 0;
      left: 25%;
      width: 50%;
      height: 50%;
      clip-path: polygon(50% 100%, 0 0, 100% 0);
    }

    .sector-down {
      bottom: 0;
      left: 25%;
      width: 50%;
      height: 50%;
      clip-path: polygon(50% 0, 0 100%, 100% 100%);
    }

    .sector-left {
      left: 0;
      top: 25%;
      width: 50%;
      height: 50%;
      clip-path: polygon(100% 50%, 0 0, 0 100%);
    }

    .sector-right {
      right: 0;
      top: 25%;
      width: 50%;
      height: 50%;
      clip-path: polygon(0 50%, 100% 0, 100% 100%);
    }

    .nav-arrow {
      position: absolute;
      width: 0;
      height: 0;
      pointer-events: none;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
      z-index: 6;
    }

    .arrow-up {
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 14px solid rgba(255,255,255,0.95);
    }

    .arrow-down {
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 14px solid rgba(255,255,255,0.95);
    }

    .arrow-left {
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 14px solid rgba(255,255,255,0.95);
    }

    .arrow-right {
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-left: 14px solid rgba(255,255,255,0.95);
    }

    .ok-btn {
      width: 36px;
      height: 36px;
      background: radial-gradient(circle at 30% 30%, var(--device-light) 0%, var(--device-color) 60%, var(--device-dark) 100%);
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.4);
      box-shadow: 
        0 3px 8px rgba(0,0,0,0.25),
        inset 0 -2px 4px rgba(0,0,0,0.2),
        inset 0 2px 4px rgba(255,255,255,0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Fredoka One', cursive;
      font-size: 10px;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      z-index: 10;
      transition: all 0.05s ease;
      position: relative;
    }

    .ok-btn:active {
      transform: scale(0.9);
      box-shadow: 
        0 1px 4px rgba(0,0,0,0.25),
        inset 0 2px 4px rgba(0,0,0,0.3);
    }

    .ok-btn.pressed {
      transform: scale(0.85);
    }

    .back-c {
      width: 85px;
      height: 42px;
      background: linear-gradient(145deg, 
        var(--device-color) 0%, 
        var(--device-dark) 100%);
      border-radius: 0 0 38px 38px;
      border: none;
      margin-top: -22px;
      padding-top: 22px;
      position: relative;
      z-index: 5;
      cursor: pointer;
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.2),
        inset 0 -2px 4px rgba(0,0,0,0.2),
        inset 0 1px 2px rgba(255,255,255,0.3);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 7px;
      font-family: 'Nunito', sans-serif;
      font-size: 11px;
      font-weight: 800;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      letter-spacing: 1px;
      transition: all 0.05s ease;
    }

    .back-c:active {
      transform: translateY(2px);
      box-shadow: 
        0 2px 4px rgba(0,0,0,0.2),
        inset 0 1px 3px rgba(0,0,0,0.25);
    }

    /* Mensajes */
    .msg-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--device-color);
      color: white;
      padding: 10px;
      font-size: 12px;
      font-weight: 800;
      text-align: center;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      font-family: 'Nunito', sans-serif;
      z-index: 20;
    }

    .msg-bar.show {
      transform: translateY(0);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-thumb { background: #F687B3; border-radius: 2px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* Responsive */
    @media (max-height: 700px) {
      .device {
        height: 550px;
      }
      .screen {
        height: 330px;
      }
    }
  </style>
</head>
<body>
  <div class="device" id="device">
    <div class="screw screw-tl"></div>
    <div class="screw screw-tr"></div>
    <div class="screw screw-bl"></div>
    <div class="screw screw-br"></div>
    
    <div class="device-logo">‚ú® TOKEJI ‚ú®</div>
    <div class="shine"></div>
    
    <div class="screen-container">
      <div class="screen zone-center" id="screen">
        <div class="status-bar">
          <span>TOKEJI</span>
          <span id="clock">12:00</span>
        </div>

        <div class="content">
          <!-- ZONA CENTRO: YO -->
          <div class="zone zone-center active" id="zone-center">
            <div class="zone-indicator indicator-up" id="ind-up">üîÆ</div>
            <div class="zone-indicator indicator-down" id="ind-down">üíå</div>
            <div class="zone-indicator indicator-left" id="ind-left">‚öîÔ∏è</div>
            <div class="zone-indicator indicator-right" id="ind-right">üî•</div>
            
            <div class="center-avatar" id="center-avatar">üê±</div>
            <div class="center-name" id="center-name">Amigo</div>
            <div class="center-status disponible" id="center-status">üü¢ Disponible</div>
            <div class="center-stats">
              <div class="center-stat" id="stat-flames">üî• 0</div>
              <div class="center-stat" id="stat-tokes">üíå 30</div>
            </div>
          </div>

          <!-- ZONA ARRIBA: MURMULLO -->
          <div class="zone zone-up" id="zone-up">
            <div class="murmullo-sky" id="murmullo-sky">
              <!-- Nubes generadas din√°micamente -->
            </div>
          </div>

          <!-- ZONA ABAJO: CABLE -->
          <div class="zone zone-down" id="zone-down">
            <div class="cable-container" id="cable-container">
              <div class="cable-line"></div>
              <!-- Nodos generados din√°micamente -->
            </div>
            
            <!-- Rueda de emociones -->
            <div class="emotion-wheel" id="emotion-wheel">
              <div class="emotion-option focused" data-emotion="love">üíï</div>
              <div class="emotion-option" data-emotion="lol">üòÇ</div>
              <div class="emotion-option" data-emotion="fire">üî•</div>
              <div class="emotion-option" data-emotion="thanks">üôè</div>
            </div>
          </div>

          <!-- ZONA IZQUIERDA: ARENA -->
          <div class="zone zone-left" id="zone-left">
            <div class="arena-title">‚öîÔ∏è ARENA</div>
            <div class="arena-modes">
              <div class="arena-mode focused" data-mode="ia">
                <div class="icon">ü§ñ</div>
                <div class="info">
                  <div class="title">VS IA</div>
                  <div class="desc">Pr√°ctica y entrenamiento</div>
                </div>
              </div>
              <div class="arena-mode" data-mode="amigo">
                <div class="icon">üë•</div>
                <div class="info">
                  <div class="title">VS Amigo</div>
                  <div class="desc">Retar a contactos</div>
                </div>
              </div>
              <div class="arena-mode" data-mode="torneo">
                <div class="icon">üèÜ</div>
                <div class="info">
                  <div class="title">Torneo</div>
                  <div class="desc">Ranking del instituto</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ZONA DERECHA: LLAMAS -->
          <div class="zone zone-right" id="zone-right">
            <div class="flames-tunnel">
              <div class="tunnel-modes">
                <div class="tunnel-mode active" data-tmode="poll">üî• Encuesta</div>
                <div class="tunnel-mode" data-tmode="rank">üìä Rank</div>
                <div class="tunnel-mode" data-tmode="secret">üíú Secreto</div>
                <div class="tunnel-mode" data-tmode="feed">üì∞ Feed</div>
              </div>
              
              <div class="poll-card" id="poll-card">
                <div class="poll-emoji">üî•</div>
                <div class="poll-question">¬øQui√©n tiene la mejor energ√≠a del curso?</div>
                <div class="poll-options" id="poll-options">
                  <!-- Opciones generadas din√°micamente -->
                </div>
                <div class="poll-timer">‚è±Ô∏è Pr√≥xima en 2h 14m</div>
              </div>
            </div>
          </div>

          <!-- MEN√ö RADIAL (Centro - OK largo) -->
          <div class="radial-menu" id="radial-menu">
            <div class="radial-center" id="radial-center">üê±</div>
            <div class="radial-item focused" data-action="color">
              üé®
              <span class="label">Color</span>
            </div>
            <div class="radial-item" data-action="theme">
              üé≠
              <span class="label">Tema</span>
            </div>
            <div class="radial-item" data-action="profile">
              üë§
              <span class="label">Perfil</span>
            </div>
            <div class="radial-item" data-action="settings">
              ‚öôÔ∏è
              <span class="label">Ajustes</span>
            </div>
          </div>

          <!-- QR OVERLAY -->
          <div class="qr-overlay" id="qr-overlay">
            <div class="qr-container" id="qr-container">
              <!-- QR generado din√°micamente -->
            </div>
            <div class="qr-hint">Escanea o agita para cerrar</div>
          </div>

          <!-- LISTA DE AMIGOS (Cable - OK largo) -->
          <div class="friends-list-overlay" id="friends-list-overlay">
            <div class="friends-list-title">üë• Mis Amigos</div>
            <div class="friends-list" id="friends-list">
              <!-- Generado din√°micamente -->
            </div>
          </div>
        </div>

        <div class="msg-bar" id="msg-bar"></div>
      </div>
    </div>

    <div class="controls-wrapper">
      <div class="dpad-circle">
        <div class="nav-ring">
          <div class="nav-sector sector-up" onclick="app.handleInput('up')" ontouchstart="app.handleTouchStart(event, 'up')" ontouchend="app.handleTouchEnd(event)"></div>
          <div class="nav-sector sector-down" onclick="app.handleInput('down')" ontouchstart="app.handleTouchStart(event, 'down')" ontouchend="app.handleTouchEnd(event)"></div>
          <div class="nav-sector sector-left" onclick="app.handleInput('left')" ontouchstart="app.handleTouchStart(event, 'left')" ontouchend="app.handleTouchEnd(event)"></div>
          <div class="nav-sector sector-right" onclick="app.handleInput('right')" ontouchstart="app.handleTouchStart(event, 'right')" ontouchend="app.handleTouchEnd(event)"></div>
          
          <div class="nav-arrow arrow-up"></div>
          <div class="nav-arrow arrow-down"></div>
          <div class="nav-arrow arrow-left"></div>
          <div class="nav-arrow arrow-right"></div>
          
          <button class="ok-btn" id="ok-btn" onclick="app.handleOK()" ontouchstart="app.handleTouchStartOK(event)" ontouchend="app.handleTouchEndOK(event)">OK</button>
        </div>
      </div>
      <button class="back-c" onclick="app.handleBack()" ontouchstart="app.handleTouchStartBack(event)" ontouchend="app.handleTouchEndBack(event)">C</button>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const BACK = "https://tokeji-device.onrender.com";

// Datos de encuestas GAS-style
const POLLS_DATA = [
  { emoji: 'üî•', question: '¬øQui√©n tiene la mejor energ√≠a del curso?' },
  { emoji: 'üíò', question: '¬øQui√©n tiene la sonrisa m√°s bonita?' },
  { emoji: 'üåü', question: '¬øA qui√©n le confiar√≠as un secreto?' },
  { emoji: 'üé≠', question: '¬øQui√©n es el m√°s gracioso sin intentarlo?' },
  { emoji: 'üëë', question: '¬øQui√©n deber√≠a ser famoso/a?' },
  { emoji: 'üí™', question: '¬øQui√©n te anima cuando est√°s baj√≥n?' }
];

const ESTADOS = [
  { id: 'disponible', emoji: 'üü¢', label: 'Disponible', color: '#48BB78' },
  { id: 'ocupado', emoji: 'üî¥', label: 'Ocupado', color: '#F56565' },
  { id: 'ausente', emoji: 'üü°', label: 'Ausente', color: '#ECC94B' }
];

const COLORES = [
  { hex: '#FF6B9D', name: 'Rosa', shadow: '#FF4785' },
  { hex: '#4299E1', name: 'Azul', shadow: '#2B6CB0' },
  { hex: '#48BB78', name: 'Verde', shadow: '#276749' },
  { hex: '#ECC94B', name: 'Amarillo', shadow: '#B7791F' },
  { hex: '#9F7AEA', name: 'Morado', shadow: '#6B46C1' }
];

const app = {
  state: {
    zone: 'center', // center | up | down | left | right
    previousZone: null,
    status: 'disponible',
    statusIndex: 0,
    color: 0,
    avatar: 'üê±',
    name: 'Amigo',
    flames: 0,
    tokes: 30,
    
    // Sub-estados
    radialOpen: false,
    radialIndex: 0,
    qrOpen: false,
    friendsListOpen: false,
    emotionWheelOpen: false,
    emotionIndex: 0,
    cableNode: null, // √≠ndice de amigo seleccionado o null
    
    // Arena
    arenaMode: 0,
    
    // Llamas
    tunnelMode: 'poll',
    pollIndex: 0,
    
    // Datos
    friends: [],
    pollOptions: [],
    
    // Timing
    okPressStart: 0,
    lastTouch: 0,
    touchDelay: 50,
    
    // Shake detection
    lastShake: 0,
    shakeThreshold: 15
  },
  
  init() {
    this.loadData();
    this.setupShake();
    this.startClock();
    this.generateFriends();
    this.generatePoll();
    this.render();
    
    // Bucle de "aburrimiento" del avatar
    setInterval(() => this.boredomCheck(), 30000);
  },
  
  loadData() {
    this.state.name = localStorage.getItem('miNombre') || 'Amigo';
    this.state.avatar = localStorage.getItem('avatar') || 'üê±';
    this.state.color = parseInt(localStorage.getItem('colorIndex')) || 0;
    this.state.status = localStorage.getItem('status') || 'disponible';
    this.state.statusIndex = ESTADOS.findIndex(e => e.id === this.state.status) || 0;
    this.state.tokes = parseInt(localStorage.getItem('toquesRestantes')) || 30;
    
    // Cargar amigos
    const contacts = JSON.parse(localStorage.getItem('cts') || '{}');
    this.state.friends = Object.entries(contacts).map(([id, name]) => ({
      id, name, avatar: localStorage.getItem('avatar_' + id) || 'üë§', streak: Math.floor(Math.random() * 5)
    }));
    
    this.applyColor();
  },
  
  applyColor() {
    const c = COLORES[this.state.color];
    document.documentElement.style.setProperty('--device-color', c.hex);
    document.documentElement.style.setProperty('--device-dark', c.shadow);
    document.documentElement.style.setProperty('--device-light', c.hex + '80');
    
    const device = document.getElementById('device');
    if (device) {
      device.style.background = `linear-gradient(145deg, ${c.hex}80 0%, ${c.hex} 50%, ${c.shadow} 100%)`;
    }
  },
  
  setupShake() {
    if (!window.DeviceMotionEvent) return;
    
    window.addEventListener('devicemotion', (e) => {
      const acc = e.accelerationIncludingGravity;
      if (!acc) return;
      
      const magnitude = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
      
      if (magnitude > this.state.shakeThreshold) {
        const now = Date.now();
        if (now - this.state.lastShake > 2000) {
          this.state.lastShake = now;
          this.onShake();
        }
      }
    });
  },
  
  onShake() {
    if (this.state.qrOpen) {
      this.closeQR();
    } else if (this.state.zone === 'center' && !this.state.radialOpen) {
      this.openQR();
    } else if (this.state.zone === 'down' && !this.state.emotionWheelOpen && !this.state.friendsListOpen) {
      // En cable: shake escanea QR nuevo amigo
      this.scanQR();
    }
  },
  
  openQR() {
    const container = document.getElementById('qr-container');
    const id = localStorage.getItem('miid') || 'demo-id';
    const data = `${id}|${this.state.name}|${this.state.avatar}`;
    
    container.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data)}" style="width: 180px; height: 180px; display: block;">`;
    
    document.getElementById('qr-overlay').classList.add('active');
    this.state.qrOpen = true;
    this.vibrate([100, 50, 100]);
  },
  
  closeQR() {
    document.getElementById('qr-overlay').classList.remove('active');
    this.state.qrOpen = false;
  },
  
  async scanQR() {
    // Simplificado: usar c√°mara si disponible, sino input manual
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      const code = prompt('Pega c√≥digo del amigo (ID|Nombre|Avatar):');
      if (code) this.processQR(code);
      return;
    }
    
    // Implementaci√≥n b√°sica de escaneo
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      // ... l√≥gica de escaneo con jsQR ...
      // Por simplicidad, usamos prompt
      setTimeout(() => {
        stream.getTracks().forEach(t => t.stop());
        const code = prompt('C√≥digo QR detectado (simulado). Pega c√≥digo:');
        if (code) this.processQR(code);
      }, 1000);
    } catch(e) {
      const code = prompt('Pega c√≥digo del amigo (ID|Nombre|Avatar):');
      if (code) this.processQR(code);
    }
  },
  
  processQR(data) {
    const parts = data.split('|');
    if (parts.length >= 2) {
      const [id, name, avatar] = parts;
      if (id && name) {
        // Guardar
        let contacts = JSON.parse(localStorage.getItem('cts') || '{}');
        contacts[id] = name;
        localStorage.setItem('cts', JSON.stringify(contacts));
        if (avatar) localStorage.setItem('avatar_' + id, avatar);
        
        // A√±adir a friends
        this.state.friends.push({ id, name, avatar: avatar || 'üë§', streak: 0 });
        this.renderCable();
        this.showMsg(`‚úÖ ${name} agregado`);
        this.vibrate([50, 100, 50]);
      }
    }
  },
  
  generateFriends() {
    // Amigos de demo si no hay
    if (this.state.friends.length === 0) {
      this.state.friends = [
        { id: 'demo1', name: 'Mar√≠a', avatar: 'ü¶ä', streak: 3 },
        { id: 'demo2', name: 'Carlos', avatar: 'üêº', streak: 0 },
        { id: 'demo3', name: 'Ana', avatar: 'ü¶Ñ', streak: 7 }
      ];
    }
  },
  
  generatePoll() {
    const poll = POLLS_DATA[Math.floor(Math.random() * POLLS_DATA.length)];
    document.querySelector('.poll-emoji').textContent = poll.emoji;
    document.querySelector('.poll-question').textContent = poll.question;
    
    // Opciones: compa√±eros del instituto (simulado)
    this.state.pollOptions = [
      { name: 'Mar√≠a L.', avatar: 'ü¶ä', id: 'm1' },
      { name: 'Carlos G.', avatar: 'üêº', id: 'c1' },
      { name: 'Ana R.', avatar: 'ü¶Ñ', id: 'a1' },
      { name: 'Luis M.', avatar: 'üêØ', id: 'l1' }
    ];
    
    const container = document.getElementById('poll-options');
    container.innerHTML = this.state.pollOptions.map((opt, i) => `
      <div class="poll-option ${i === 0 ? 'focused' : ''}" data-index="${i}">
        <span class="avatar">${opt.avatar}</span>
        <div>${opt.name}</div>
      </div>
    `).join('');
  },
  
  boredomCheck() {
    const avatar = document.getElementById('center-avatar');
    if (this.state.zone === 'center' && !this.state.radialOpen && Math.random() > 0.5) {
      avatar.classList.add('bored');
      setTimeout(() => avatar.classList.remove('bored'), 5000);
    }
  },
  
  startClock() {
    const update = () => {
      const now = new Date();
      document.getElementById('clock').textContent = 
        String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
    };
    update();
    setInterval(update, 60000);
  },
  
  // INPUT HANDLING
  
  handleInput(direction) {
    const now = Date.now();
    if (now - this.state.lastTouch < this.state.touchDelay) return;
    this.state.lastTouch = now;
    
    this.playSound('move');
    
    // Manejar overlays primero
    if (this.state.qrOpen) {
      this.closeQR();
      return;
    }
    
    if (this.state.radialOpen) {
      this.navigateRadial(direction);
      return;
    }
    
    if (this.state.friendsListOpen) {
      this.navigateFriendsList(direction);
      return;
    }
    
    if (this.state.emotionWheelOpen) {
      this.navigateEmotionWheel(direction);
      return;
    }
    
    // Navegaci√≥n entre zonas
    if (this.state.zone === 'center') {
      if (direction === 'up') this.goToZone('up');
      else if (direction === 'down') this.goToZone('down');
      else if (direction === 'left') this.goToZone('left');
      else if (direction === 'right') this.goToZone('right');
    } else {
      // En zona, C o direcci√≥n opuesta vuelve a centro
      const backDirections = { up: 'down', down: 'up', left: 'right', right: 'left' };
      if (direction === backDirections[this.state.zone] || direction === 'center') {
        this.goToZone('center');
      } else {
        // Navegaci√≥n dentro de zona
        this.navigateInZone(direction);
      }
    }
  },
  
  goToZone(zone) {
    this.state.previousZone = this.state.zone;
    this.state.zone = zone;
    
    // Actualizar clases
    const screen = document.getElementById('screen');
    screen.className = `screen zone-${zone}`;
    
    // Mostrar zona correcta
    document.querySelectorAll('.zone').forEach(z => z.classList.remove('active'));
    document.getElementById(`zone-${zone}`).classList.add('active');
    
    // Actualizar indicadores
    document.querySelectorAll('.zone-indicator').forEach(ind => ind.classList.remove('active'));
    if (zone === 'center') {
      document.getElementById('ind-up').classList.add('active');
      document.getElementById('ind-down').classList.add('active');
      document.getElementById('ind-left').classList.add('active');
      document.getElementById('ind-right').classList.add('active');
    }
    
    this.vibrate(20);
    this.render();
  },
  
  navigateInZone(direction) {
    switch(this.state.zone) {
      case 'up':
        this.navigateMurmullo(direction);
        break;
      case 'down':
        this.navigateCable(direction);
        break;
      case 'left':
        this.navigateArena(direction);
        break;
      case 'right':
        this.navigateLlamas(direction);
        break;
    }
  },
  
  // NAVEGACI√ìN ESPEC√çFICA POR ZONA
  
  navigateMurmullo(direction) {
    // Scroll entre nubes
    const clouds = document.querySelectorAll('.cloud');
    // Implementaci√≥n b√°sica: re-generar nubes con offset
    this.generateClouds(Math.random() * 100);
  },
  
  generateClouds(offset = 0) {
    const sky = document.getElementById('murmullo-sky');
    const events = [
      { emoji: 'üíú', text: 'Mar√≠a recibi√≥ 5 flames', y: 20 + offset },
      { emoji: 'üî•', text: 'Nuevo crush en 4¬∫ ESO', y: 60 + offset },
      { emoji: '‚öîÔ∏è', text: 'Carlos gan√≥ 3 combates', y: 100 + offset },
      { emoji: '‚ú®', text: '3 nuevos se unieron', y: 140 + offset },
      { emoji: 'üíé', text: 'Tienda: nuevo tema', y: 180 + offset, golden: true }
    ];
    
    sky.innerHTML = events.map((e, i) => `
      <div class="cloud ${e.golden ? 'golden' : ''} ${i === 0 ? 'focused' : ''}" 
           style="top: ${e.y}px; left: ${10 + (i % 2) * 40}px;">
        ${e.emoji} ${e.text}
      </div>
    `).join('');
  },
  
  navigateCable(direction) {
    if (this.state.friends.length === 0) return;
    
    if (direction === 'left' || direction === 'right') {
      // Mover entre nodos
      if (this.state.cableNode === null) {
        this.state.cableNode = 0;
      } else {
        const delta = direction === 'left' ? -1 : 1;
        this.state.cableNode = (this.state.cableNode + delta + this.state.friends.length) % this.state.friends.length;
      }
      this.renderCable();
      this.vibrate(10);
    }
  },
  
  renderCable() {
    const container = document.getElementById('cable-container');
    const line = container.querySelector('.cable-line');
    
    // Limpiar nodos antiguos (excepto l√≠nea)
    container.querySelectorAll('.cable-node').forEach(n => n.remove());
    
    // Crear nodos
    this.state.friends.forEach((friend, i) => {
      const node = document.createElement('div');
      node.className = `cable-node ${i === this.state.cableNode ? 'focused' : ''}`;
      
      // Posici√≥n circular alrededor del centro
      const angle = (i / this.state.friends.length) * Math.PI * 2 - Math.PI / 2;
      const radius = 100;
      const x = Math.cos(angle) * radius + 110; // centro del container (220px / 2)
      const y = Math.sin(angle) * radius + 110;
      
      node.style.left = `${x - 30}px`; // -30 es mitad del ancho del nodo
      node.style.top = `${y - 30}px`;
      
      node.innerHTML = `
        ${friend.avatar}
        <span class="name">${friend.name}</span>
        ${friend.streak > 0 ? `<span class="streak">${friend.streak}</span>` : ''}
      `;
      
      container.appendChild(node);
    });
  },
  
  navigateArena(direction) {
    const modes = document.querySelectorAll('.arena-mode');
    if (direction === 'up') {
      this.state.arenaMode = Math.max(0, this.state.arenaMode - 1);
    } else if (direction === 'down') {
      this.state.arenaMode = Math.min(modes.length - 1, this.state.arenaMode + 1);
    }
    
    modes.forEach((m, i) => m.classList.toggle('focused', i === this.state.arenaMode));
    this.vibrate(10);
  },
  
  navigateLlamas(direction) {
    if (direction === 'up' || direction === 'down') {
      // Cambiar modo del t√∫nel
      const modes = ['poll', 'rank', 'secret', 'feed'];
      const currentIdx = modes.indexOf(this.state.tunnelMode);
      const newIdx = direction === 'up' 
        ? Math.max(0, currentIdx - 1)
        : Math.min(modes.length - 1, currentIdx + 1);
      this.state.tunnelMode = modes[newIdx];
      
      document.querySelectorAll('.tunnel-mode').forEach((m, i) => {
        m.classList.toggle('active', i === newIdx);
      });
      
      this.renderTunnelContent();
    } else if (direction === 'left' || direction === 'right') {
      // Navegar opciones de encuesta
      const options = document.querySelectorAll('.poll-option');
      if (direction === 'left') {
        this.state.pollIndex = Math.max(0, this.state.pollIndex - 1);
      } else {
        this.state.pollIndex = Math.min(options.length - 1, this.state.pollIndex + 1);
      }
      
      options.forEach((o, i) => o.classList.toggle('focused', i === this.state.pollIndex));
    }
  },
  
  renderTunnelContent() {
    const card = document.getElementById('poll-card');
    if (this.state.tunnelMode === 'poll') {
      card.style.display = 'block';
      this.generatePoll();
    } else {
      card.innerHTML = `<div style="text-align: center; padding: 40px 20px; color: white;">
        <div style="font-size: 40px; margin-bottom: 10px;">${this.state.tunnelMode === 'rank' ? 'üìä' : this.state.tunnelMode === 'secret' ? 'üíú' : 'üì∞'}</div>
        <div style="font-family: Fredoka One; font-size: 16px;">${this.state.tunnelMode === 'rank' ? 'Rankings pr√≥ximamente' : this.state.tunnelMode === 'secret' ? 'Sobres secretos' : 'Feed del instituto'}</div>
      </div>`;
    }
  },
  
  // MEN√ö RADIAL
  
  openRadial() {
    document.getElementById('radial-menu').classList.add('active');
    this.state.radialOpen = true;
    this.state.radialIndex = 0;
    this.renderRadial();
  },
  
  closeRadial() {
    document.getElementById('radial-menu').classList.remove('active');
    this.state.radialOpen = false;
  },
  
  navigateRadial(direction) {
    const items = document.querySelectorAll('.radial-item');
    const positions = { up: 0, right: 1, down: 2, left: 3 };
    
    if (positions[direction] !== undefined) {
      this.state.radialIndex = positions[direction];
      this.renderRadial();
      this.vibrate(10);
    }
  },
  
  renderRadial() {
    document.querySelectorAll('.radial-item').forEach((item, i) => {
      item.classList.toggle('focused', i === this.state.radialIndex);
    });
  },
  
  activateRadial() {
    const actions = ['color', 'theme', 'profile', 'settings'];
    const action = actions[this.state.radialIndex];
    
    switch(action) {
      case 'color':
        this.cycleColor();
        break;
      case 'theme':
        this.showMsg('üé≠ Temas pr√≥ximamente');
        break;
      case 'profile':
        const newName = prompt('Tu nombre:', this.state.name);
        if (newName) {
          this.state.name = newName;
          localStorage.setItem('miNombre', newName);
          this.render();
        }
        break;
      case 'settings':
        this.showMsg('‚öôÔ∏è Ajustes: Sonido ON, Vibraci√≥n ON');
        break;
    }
    
    this.closeRadial();
  },
  
  cycleColor() {
    this.state.color = (this.state.color + 1) % COLORES.length;
    localStorage.setItem('colorIndex', this.state.color);
    this.applyColor();
    this.showMsg(`üé® ${COLORES[this.state.color].name}`);
  },
  
  // EMOTION WHEEL
  
  openEmotionWheel() {
    document.getElementById('emotion-wheel').classList.add('active');
    this.state.emotionWheelOpen = true;
    this.state.emotionIndex = 0;
    this.renderEmotionWheel();
  },
  
  closeEmotionWheel() {
    document.getElementById('emotion-wheel').classList.remove('active');
    this.state.emotionWheelOpen = false;
  },
  
  navigateEmotionWheel(direction) {
    const map = { up: 0, right: 1, down: 2, left: 3 };
    if (map[direction] !== undefined) {
      this.state.emotionIndex = map[direction];
      this.renderEmotionWheel();
      this.vibrate(10);
    }
  },
  
  renderEmotionWheel() {
    document.querySelectorAll('.emotion-option').forEach((opt, i) => {
      opt.classList.toggle('focused', i === this.state.emotionIndex);
    });
  },
  
  sendEmotion() {
    const emotions = ['love', 'lol', 'fire', 'thanks'];
    const emotion = emotions[this.state.emotionIndex];
    const friend = this.state.friends[this.state.cableNode];
    
    if (friend) {
      this.showMsg(`${emotion === 'love' ? 'üíï' : emotion === 'lol' ? 'üòÇ' : emotion === 'fire' ? 'üî•' : 'üôè'} a ${friend.name}`);
      this.vibrate([50, 100, 50]);
      
      // Incrementar streak
      friend.streak++;
      this.renderCable();
    }
    
    this.closeEmotionWheel();
  },
  
  // FRIENDS LIST
  
  openFriendsList() {
    const list = document.getElementById('friends-list');
    list.innerHTML = this.state.friends.map((f, i) => `
      <div class="friend-item ${i === 0 ? 'focused' : ''}" data-index="${i}">
        <span style="font-size: 24px;">${f.avatar}</span>
        <div style="flex: 1;">
          <div style="font-weight: 800;">${f.name}</div>
          <div style="font-size: 10px; color: #718096;">Racha: ${f.streak} d√≠as</div>
        </div>
      </div>
    `).join('');
    
    document.getElementById('friends-list-overlay').classList.add('active');
    this.state.friendsListOpen = true;
  },
  
  closeFriendsList() {
    document.getElementById('friends-list-overlay').classList.remove('active');
    this.state.friendsListOpen = false;
  },
  
  navigateFriendsList(direction) {
    const items = document.querySelectorAll('.friend-item');
    if (direction === 'up') {
      // No hay scroll up en lista simple
    } else if (direction === 'down') {
      // Scroll
    }
  },
  
  // OK Y BACK
  
  handleOK() {
    this.state.okPressStart = Date.now();
    
    // Overlays
    if (this.state.qrOpen) {
      this.closeQR();
      return;
    }
    
    if (this.state.radialOpen) {
      this.activateRadial();
      return;
    }
    
    if (this.state.friendsListOpen) {
      this.closeFriendsList();
      return;
    }
    
    if (this.state.emotionWheelOpen) {
      this.sendEmotion();
      return;
    }
    
    // Zonas
    switch(this.state.zone) {
      case 'center':
        // OK largo = men√∫ radial, corto = cambiar estado
        setTimeout(() => {
          const pressDuration = Date.now() - this.state.okPressStart;
          if (pressDuration < 500) {
            // Cambiar estado
            this.cycleStatus();
          } else {
            this.openRadial();
          }
        }, 100);
        break;
        
      case 'up':
        // Expandir nube seleccionada
        this.showMsg('üîÆ Detalle del murmullo');
        break;
        
      case 'down':
        // Si hay nodo seleccionado: abrir rueda de emociones
        // Si no: abrir lista de amigos
        if (this.state.cableNode !== null) {
          this.openEmotionWheel();
        } else {
          this.openFriendsList();
        }
        break;
        
      case 'left':
        // Entrar modo arena seleccionado
        const modes = ['ia', 'amigo', 'torneo'];
        this.showMsg(`‚öîÔ∏è Modo ${modes[this.state.arenaMode]}`);
        break;
        
      case 'right':
        // Votar en encuesta
        if (this.state.tunnelMode === 'poll') {
          const option = this.state.pollOptions[this.state.pollIndex];
          this.showMsg(`üî• Votaste por ${option.name}`);
          this.state.flames++;
          document.getElementById('stat-flames').textContent = `üî• ${this.state.flames}`;
          this.vibrate([100, 50, 100]);
        }
        break;
    }
  },
  
  cycleStatus() {
    this.state.statusIndex = (this.state.statusIndex + 1) % ESTADOS.length;
    this.state.status = ESTADOS[this.state.statusIndex].id;
    localStorage.setItem('status', this.state.status);
    this.render();
    this.showMsg(`${ESTADOS[this.state.statusIndex].emoji} ${ESTADOS[this.state.statusIndex].label}`);
  },
  
  handleBack() {
    // Cerrar overlays primero
    if (this.state.qrOpen) {
      this.closeQR();
      return;
    }
    if (this.state.radialOpen) {
      this.closeRadial();
      return;
    }
    if (this.state.friendsListOpen) {
      this.closeFriendsList();
      return;
    }
    if (this.state.emotionWheelOpen) {
      this.closeEmotionWheel();
      return;
    }
    
    // Volver a centro desde cualquier zona
    if (this.state.zone !== 'center') {
      this.goToZone('center');
    }
  },
  
  // UTILIDADES
  
  render() {
    // Actualizar centro
    document.getElementById('center-avatar').textContent = this.state.avatar;
    document.getElementById('center-name').textContent = this.state.name;
    
    const statusEl = document.getElementById('center-status');
    const estado = ESTADOS[this.state.statusIndex];
    statusEl.textContent = `${estado.emoji} ${estado.label}`;
    statusEl.className = `center-status ${estado.id}`;
    
    document.getElementById('stat-flames').textContent = `üî• ${this.state.flames}`;
    document.getElementById('stat-tokes').textContent = `üíå ${this.state.tokes}`;
    
    // Renderizar zonas espec√≠ficas
    if (this.state.zone === 'down') {
      this.renderCable();
    } else if (this.state.zone === 'up') {
      this.generateClouds();
    }
  },
  
  showMsg(text) {
    const bar = document.getElementById('msg-bar');
    bar.textContent = text;
    bar.classList.add('show');
    setTimeout(() => bar.classList.remove('show'), 2500);
  },
  
  vibrate(pattern) {
    if (navigator.vibrate) {
      navigator.vibrate(pattern);
    }
  },
  
  playSound(type) {
    // S√≠ntesis b√°sica con Web Audio API (sin archivos externos)
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      if (type === 'move') {
        osc.frequency.setValueAtTime(400, ctx.currentTime);
        gain.gain.setValueAtTime(0.05, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.05);
      } else if (type === 'select') {
        osc.frequency.setValueAtTime(600, ctx.currentTime);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      }
    } catch(e) {}
  },
  
  // TOUCH HANDLERS
  
  handleTouchStart(event, direction) {
    event.preventDefault();
    const sector = event.target;
    sector.style.background = 'rgba(0,0,0,0.15)';
    this.handleInput(direction);
  },
  
  handleTouchEnd(event) {
    event.preventDefault();
    const sector = event.target;
    sector.style.background = '';
  },
  
  handleTouchStartOK(event) {
    event.preventDefault();
    document.getElementById('ok-btn').classList.add('pressed');
    this.handleOK();
  },
  
  handleTouchEndOK(event) {
    event.preventDefault();
    document.getElementById('ok-btn').classList.remove('pressed');
  },
  
  handleTouchStartBack(event) {
    event.preventDefault();
    event.target.style.transform = 'translateY(2px)';
    this.handleBack();
  },
  
  handleTouchEndBack(event) {
    event.preventDefault();
    event.target.style.transform = '';
  }
};

// Inicializar
window.addEventListener('load', () => {
  app.init();
});
</script>
</body>
</html>