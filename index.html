<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Tokeji - Device</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <meta name="theme-color" content="#8b5cf6"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Nunito', sans-serif;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --device-color: #8b5cf6;
      --device-light: #a78bfa;
      --device-dark: #7c3aed;
      --screen-bg: #f8fafc;
      --text-color: #2d3748;
      --focus-color: #ff0066;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    /* DEVICE SHELL */
    .device {
      width: 360px;
      height: 700px;
      background: linear-gradient(145deg, #c4b5fd 0%, #a78bfa 50%, #8b5cf6 100%);
      border-radius: 60px 60px 50px 50px;
      padding: 25px 20px 20px 20px;
      box-shadow: 
        0 30px 60px rgba(0,0,0,0.4),
        inset 0 5px 15px rgba(255,255,255,0.4),
        inset 0 -5px 15px rgba(0,0,0,0.2);
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .device::before {
      content: '';
      position: absolute;
      top: 0;
      left: 20%;
      right: 20%;
      height: 40%;
      background: linear-gradient(180deg, 
        rgba(255,255,255,0.4) 0%, 
        rgba(255,255,255,0.1) 50%,
        transparent 100%);
      border-radius: 50% 50% 0 0;
      pointer-events: none;
    }

    .device-logo {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      font-weight: 900;
      color: rgba(255,255,255,0.8);
      letter-spacing: 3px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .screw {
      position: absolute;
      width: 10px;
      height: 10px;
      background: linear-gradient(145deg, #e5e7eb, #9ca3af);
      border-radius: 50%;
      box-shadow: inset 0 2px 3px rgba(255,255,255,0.5), 0 2px 4px rgba(0,0,0,0.3);
      z-index: 10;
    }

    .screw::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      width: 6px;
      height: 2px;
      background: #6b7280;
      box-shadow: 0 0 0 1px #6b7280;
    }

    .screw-tl { top: 12px; left: 15px; }
    .screw-tr { top: 12px; right: 15px; }
    .screw-bl { bottom: 140px; left: 15px; }
    .screw-br { bottom: 140px; right: 15px; }

    /* SCREEN */
    .screen-container {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 10px;
    }

    .screen {
      width: 310px;
      height: 380px;
      background: var(--screen-bg);
      border-radius: 20px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        inset 0 3px 10px rgba(0,0,0,0.15),
        0 2px 5px rgba(255,255,255,0.5);
      border: 6px solid #374151;
      display: flex;
      flex-direction: column;
    }

    .status-bar {
      position: absolute;
      top: 6px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      font-weight: 700;
      color: #64748b;
      z-index: 10;
    }

    /* CONTENT AREA */
    .content {
      flex: 1;
      padding: 30px 12px 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    /* PAGES */
    .page { 
      display: none; 
      width: 100%; 
      height: 100%;
      flex-direction: column;
    }
    .page.active { display: flex; }

    /* SPLASH */
    #page-splash {
      justify-content: center;
      align-items: center;
      text-align: center;
      background: linear-gradient(145deg, #8b5cf6, #a78bfa);
      height: 100%;
      padding: 0;
    }

    .splash-logo {
      font-size: 36px;
      font-weight: 900;
      color: white;
      letter-spacing: 4px;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    .splash-sub {
      font-size: 11px;
      color: rgba(255,255,255,0.8);
      margin-top: 8px;
      letter-spacing: 2px;
    }

    .splash-hint {
      position: absolute;
      bottom: 40px;
      font-size: 10px;
      color: rgba(255,255,255,0.7);
      animation: blink 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
    }

    @keyframes blink {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    /* SETUP */
    .setup-title {
      font-size: 16px;
      font-weight: 900;
      color: var(--text-color);
      margin-bottom: 15px;
      text-align: center;
    }

    .setup-input {
      width: 85%;
      padding: 12px;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
      outline: none;
      font-weight: 700;
      background: white;
      margin: 8px 0;
    }

    .setup-input:focus { 
      border-color: var(--focus-color); 
      box-shadow: 0 0 0 3px rgba(255,0,102,0.2);
    }

    /* HOME - NUEVO DISEÃ‘O */
    .home-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .home-avatar {
      font-size: 70px;
      filter: drop-shadow(0 8px 15px rgba(0,0,0,0.15));
      animation: breathe 3s ease-in-out infinite;
      margin-bottom: 10px;
    }

    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05) translateY(-3px); }
    }

    .home-name {
      font-size: 20px;
      font-weight: 900;
      color: var(--text-color);
      margin-bottom: 5px;
    }

    .home-status {
      display: inline-block;
      background: linear-gradient(145deg, #48bb78, #38a169);
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 800;
      box-shadow: 0 3px 0 #276749;
      margin-bottom: 10px;
    }

    .tokes-counter {
      background: linear-gradient(145deg, #8b5cf6, #7c3aed);
      color: white;
      padding: 6px 16px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 800;
      box-shadow: 0 3px 0 #5b21b6;
    }

    .home-hint {
      margin-top: auto;
      font-size: 10px;
      color: #94a3b8;
      text-align: center;
      padding: 10px;
    }

    /* CAROUSEL MENU */
    .carousel-container {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .carousel-track {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px 0;
      position: relative;
      height: 120px;
    }

    .carousel-btn {
      width: 70px;
      height: 90px;
      background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
      border: 3px solid transparent;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-size: 9px;
      font-weight: 800;
      color: #64748b;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
    }

    .carousel-btn .icon {
      font-size: 28px;
      transition: transform 0.3s;
    }

    .carousel-btn.focused {
      background: linear-gradient(145deg, var(--device-light), var(--device-color));
      color: white;
      border-color: var(--focus-color);
      transform: scale(1.15);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
      z-index: 10;
    }

    .carousel-btn.focused .icon {
      transform: scale(1.2);
    }

    .carousel-btn.side {
      opacity: 0.5;
      transform: scale(0.85);
    }

    .carousel-btn.hidden {
      display: none;
    }

    .carousel-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: #cbd5e1;
      animation: arrowPulse 1.5s infinite;
    }

    .carousel-arrow.left { left: 5px; }
    .carousel-arrow.right { right: 5px; }

    @keyframes arrowPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* LIST SCREENS (Contacts, Tokes categories) */
    .list-container {
      width: 100%;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .list-item {
      background: white;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
    }

    .list-item.focused {
      border-color: var(--focus-color);
      background: #fdf2f8;
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(255,0,102,0.2);
    }

    .list-item .emoji {
      font-size: 20px;
    }

    /* QR SCREEN */
    .qr-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    #qr-mio {
      background: white;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 15px 0;
    }

    #qr-mio img {
      width: 160px;
      height: 160px;
      display: block;
    }

    /* TODEX GRID */
    .todex-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
      width: 100%;
      flex: 1;
      overflow-y: auto;
      padding: 5px;
    }

    .emoji-card {
      aspect-ratio: 1;
      background: #e2e8f0;
      border: 2px solid transparent;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }

    .emoji-card.captured {
      background: linear-gradient(135deg, #00c598, #00ddaa);
      border-color: #059669;
    }

    .emoji-card.focused {
      border-color: var(--focus-color);
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(255,0,102,0.3);
      z-index: 10;
    }

    /* COMBATE */
    .combate-options {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
      justify-content: center;
      width: 100%;
    }

    .combate-btn {
      background: linear-gradient(145deg, #8b5cf6, #7c3aed);
      color: white;
      border: 3px solid transparent;
      padding: 20px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
    }

    .combate-btn.focused {
      border-color: var(--focus-color);
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    /* SETTINGS */
    .settings-grid {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      justify-content: center;
    }

    .setting-item {
      background: white;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 700;
    }

    .setting-item.focused {
      border-color: var(--focus-color);
      background: #fdf2f8;
    }

    .toggle {
      width: 40px;
      height: 20px;
      background: #cbd5e1;
      border-radius: 10px;
      position: relative;
      transition: all 0.3s;
    }

    .toggle.active {
      background: #48bb78;
    }

    .toggle::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle.active::after {
      left: 22px;
    }

    /* RESPONSE MODAL */
    .response-modal {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
      backdrop-filter: blur(5px);
    }

    .response-modal.active {
      display: flex;
    }

    .response-title {
      color: white;
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 20px;
      text-align: center;
    }

    .response-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      width: 100%;
      max-width: 250px;
    }

    .response-btn {
      background: linear-gradient(145deg, #ff0066, #ff3388);
      color: white;
      border: 3px solid transparent;
      border-radius: 16px;
      padding: 20px;
      font-size: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }

    .response-btn .label {
      font-size: 10px;
      font-weight: 700;
    }

    .response-btn.focused {
      border-color: white;
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255,0,102,0.6);
    }

    .response-actions {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .response-action-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .response-action-btn.focused {
      background: white;
      color: #333;
    }

    /* PHYSICAL BUTTONS */
    .controls {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .btn-physical {
      background: linear-gradient(145deg, #374151, #1f2937);
      border: none;
      color: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 
        0 6px 0 #111827,
        0 8px 10px rgba(0,0,0,0.3),
        inset 0 2px 3px rgba(255,255,255,0.1);
      cursor: pointer;
      transition: all 0.1s;
      font-weight: 700;
    }

    .btn-physical:active {
      transform: translateY(4px);
      box-shadow: 
        0 2px 0 #111827,
        0 4px 6px rgba(0,0,0,0.3),
        inset 0 2px 3px rgba(255,255,255,0.1);
    }

    .btn-back {
      width: 60px;
      height: 40px;
      border-radius: 20px;
      font-size: 11px;
    }

    .btn-ok {
      width: 70px;
      height: 50px;
      border-radius: 25px;
      font-size: 14px;
      background: linear-gradient(145deg, #ff0066, #cc0052);
      box-shadow: 
        0 6px 0 #99003d,
        0 8px 10px rgba(0,0,0,0.3),
        inset 0 2px 3px rgba(255,255,255,0.2);
    }

    .btn-ok:active {
      box-shadow: 
        0 2px 0 #99003d,
        0 4px 6px rgba(0,0,0,0.3),
        inset 0 2px 3px rgba(255,255,255,0.2);
    }

    .btn-dpad {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      font-size: 20px;
    }

    .dpad-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
      background: rgba(0,0,0,0.2);
      padding: 8px;
      border-radius: 20px;
    }

    .dpad-empty { visibility: hidden; }

    /* HINT */
    .controls-hint {
      color: rgba(255,255,255,0.6);
      font-size: 10px;
      text-align: center;
      margin-top: 5px;
    }

    /* MSG */
    .msg-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(139, 92, 246, 0.95);
      color: white;
      padding: 8px;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      transform: translateY(100%);
      transition: transform 0.3s;
    }

    .msg-bar.show {
      transform: translateY(0);
    }

    /* ANIMATIONS */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .page.active > * {
      animation: slideIn 0.3s ease-out;
    }

    /* Scrollbar hide */
    .content::-webkit-scrollbar { display: none; }
    .todex-grid::-webkit-scrollbar { width: 4px; }
    .todex-grid::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 2px; }
  </style>
</head>
<body>
  <div class="device">
    <div class="device-logo">TOKEJI</div>
    <div class="screw screw-tl"></div>
    <div class="screw screw-tr"></div>
    <div class="screw screw-bl"></div>
    <div class="screw screw-br"></div>
    
    <div class="screen-container">
      <div class="screen">
        <div class="status-bar">
          <span>TOKEJI</span>
          <span id="clock">12:00</span>
        </div>

        <div class="content" id="content-area">
          <!-- SPLASH -->
          <div class="page active" id="page-splash">
            <div class="splash-logo">TOKEJI</div>
            <div class="splash-sub">DEVICE</div>
            <div class="splash-hint">Pulsa OK para empezar</div>
          </div>

          <!-- SETUP -->
          <div class="page" id="page-setup">
            <div class="setup-title">Â¿CÃ“MO TE LLAMAS?</div>
            <input type="text" id="miNombre" class="setup-input" maxlength="8" placeholder="TU NOMBRE" autocomplete="off">
            <div style="font-size: 10px; color: #94a3b8; margin-top: 10px;">Pulsa OK para continuar</div>
          </div>

          <!-- HOME -->
          <div class="page" id="page-home">
            <div class="home-main">
              <div class="home-avatar" id="home-avatar">ğŸ±</div>
              <div class="home-name" id="home-name">Usuario</div>
              <div class="home-status" id="home-status">ğŸŸ¢ Disponible</div>
              <div class="tokes-counter" id="tokes-counter">ğŸ¯ 30/30</div>
            </div>
            <div class="home-hint">â–¼ Abrir menÃº</div>
          </div>

          <!-- MENU CAROUSEL -->
          <div class="page" id="page-menu">
            <div class="setup-title">MENÃš</div>
            <div class="carousel-container">
              <div class="carousel-arrow left">â—„</div>
              <div class="carousel-track" id="carousel-track">
                <!-- Generated by JS -->
              </div>
              <div class="carousel-arrow right">â–º</div>
            </div>
            <div style="font-size: 10px; color: #94a3b8; text-align: center; margin-top: 10px;">
              â—„ â–º Mover â€¢ OK Seleccionar
            </div>
          </div>

          <!-- TOKES CATEGORIES -->
          <div class="page" id="page-tokes">
            <div class="setup-title">ENVIAR TOQUE</div>
            <div class="list-container" id="tokes-list">
              <!-- Generated by JS -->
            </div>
            <div style="font-size: 10px; color: #94a3b8; text-align: center; margin-top: 5px;">
              Selecciona tipo de toque
            </div>
          </div>

          <!-- CONTACTS -->
          <div class="page" id="page-contacts">
            <div class="setup-title">SELECCIONAR AMIGO</div>
            <div class="list-container" id="contacts-list">
              <!-- Generated by JS -->
            </div>
            <div style="font-size: 10px; color: #94a3b8; text-align: center; margin-top: 5px;">
              â–²â–¼ Mover â€¢ OK Elegir
            </div>
          </div>

          <!-- QR -->
          <div class="page" id="page-qr">
            <div class="setup-title">TU CÃ“DIGO QR</div>
            <div class="qr-container">
              <div id="qr-mio"></div>
              <div style="font-size: 11px; color: #64748b; text-align: center;">
                MuÃ©stralo a tus amigos<br>
                para que te agreguen
              </div>
            </div>
          </div>

          <!-- TODEX -->
          <div class="page" id="page-todox">
            <div class="setup-title">TODEX <span id="todex-count" style="font-size: 14px; color: #8b5cf6;">0/150</span></div>
            <div class="todex-grid" id="todex-grid"></div>
          </div>

          <!-- COMBATES -->
          <div class="page" id="page-combates">
            <div class="setup-title">âš”ï¸ COMBATES</div>
            <div class="combate-options">
              <div class="combate-btn" data-index="0">
                <span>ğŸ¤–</span> VS IA
              </div>
              <div class="combate-btn" data-index="1">
                <span>âš”ï¸</span> VS AMIGO
              </div>
            </div>
          </div>

          <!-- SETTINGS -->
          <div class="page" id="page-settings">
            <div class="setup-title">âš™ï¸ AJUSTES</div>
            <div class="settings-grid">
              <div class="setting-item" data-index="0">
                <span>ğŸ”Š Sonido</span>
                <div class="toggle active" id="toggle-sonido"></div>
              </div>
              <div class="setting-item" data-index="1">
                <span>ğŸ“³ VibraciÃ³n</span>
                <div class="toggle active" id="toggle-vibra"></div>
              </div>
              <div class="setting-item" data-index="2">
                <span>ğŸ¨ Color dispositivo</span>
                <span id="color-preview" style="width: 20px; height: 20px; background: #8b5cf6; border-radius: 50%;"></span>
              </div>
              <div class="setting-item" data-index="3">
                <span>ğŸŸ¢ Cambiar estado</span>
                <span id="status-preview" style="font-size: 10px;">Disponible</span>
              </div>
              <div class="setting-item" data-index="4" style="color: #ef4444;">
                <span>ğŸ—‘ï¸ Reiniciar todo</span>
              </div>
            </div>
          </div>

          <!-- RESPONSE MODAL -->
          <div class="response-modal" id="response-modal">
            <div class="response-title" id="response-title">ğŸ‰ Toque de MarÃ­a!</div>
            <div class="response-grid">
              <div class="response-btn" data-index="0">
                ğŸ’•<span class="label">Love</span>
              </div>
              <div class="response-btn" data-index="1">
                ğŸ˜‚<span class="label">LOL</span>
              </div>
              <div class="response-btn" data-index="2">
                ğŸ™<span class="label">Gracias</span>
              </div>
              <div class="response-btn" data-index="3">
                ğŸ”¥<span class="label">Fuego</span>
              </div>
            </div>
            <div class="response-actions">
              <div class="response-action-btn" data-action="ignore">â—„ Ignorar</div>
              <div class="response-action-btn focused" data-action="send">OK Responder</div>
            </div>
          </div>
        </div>

        <div class="msg-bar" id="msg-bar"></div>
      </div>
    </div>

    <!-- PHYSICAL CONTROLS -->
    <div class="controls">
      <div class="controls-row">
        <button class="btn-physical btn-back" onclick="handleBack()">â—„ ATRÃS</button>
        <button class="btn-physical btn-ok" onclick="handleOK()">OK</button>
        <div class="dpad-container">
          <div class="dpad-empty"></div>
          <button class="btn-physical btn-dpad" onclick="handleUp()">â–²</button>
          <div class="dpad-empty"></div>
          <button class="btn-physical btn-dpad" onclick="handleLeft()">â—„</button>
          <button class="btn-physical btn-dpad" onclick="handleDown()">â–¼</button>
          <button class="btn-physical btn-dpad" onclick="handleRight()">â–º</button>
        </div>
      </div>
      <div class="controls-hint">Usa los botones para navegar</div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
// ========================================
// TOKEJI - CONTROL 100% BOTONES FÃSICOS
// ========================================

const BACK = "https://dame-un-toque-1.onrender.com";
let miID = localStorage.getItem("miid");
if (!miID) {
  miID = crypto.randomUUID().slice(0, 10);
  localStorage.setItem("miid", miID);
}

let contactos = {};
try {
  contactos = JSON.parse(localStorage.getItem("cts") || "{}");
} catch(e) { contactos = {}; }

// ESTADO DE NAVEGACIÃ“N
const state = {
  currentPage: 'splash',
  menuIndex: 0,
  focus: { type: 'none', index: 0 },
  history: [],
  toquesRestantes: parseInt(localStorage.getItem("toquesRestantes") || "30"),
  selectedTokeType: null,
  pendingToque: null,
  settings: {
    sonido: localStorage.getItem('sonido') !== 'off',
    vibracion: localStorage.getItem('vibracion') !== 'off',
    colorIndex: parseInt(localStorage.getItem('colorIndex') || '0'),
    status: localStorage.getItem('status') || 'disponible'
  }
};

const MENU_ITEMS = [
  { id: 'tokes', icon: 'ğŸ’Œ', label: 'Tokes', color: '#ff0066' },
  { id: 'contacts', icon: 'ğŸ‘¥', label: 'Amigos', color: '#0081ff' },
  { id: 'qr', icon: 'ğŸ“±', label: 'Mi QR', color: '#00c598' },
  { id: 'todox', icon: 'ğŸ“–', label: 'ToDox', color: '#ffb800' },
  { id: 'combates', icon: 'âš”ï¸', label: 'Combates', color: '#9400D3' },
  { id: 'settings', icon: 'âš™ï¸', label: 'Ajustes', color: '#64748b' },
  { id: 'scan', icon: 'ğŸ“·', label: 'Escanear', color: '#ff5400' }
];

const TOKES_TYPES = [
  { id: 1, emoji: 'ğŸ”¥', name: 'On Fire', color: '#ff0066', desc: 'EstÃ¡s imparable' },
  { id: 2, emoji: 'ğŸ’•', name: 'Crush', color: '#ff3388', desc: 'Alguien piensa en ti' },
  { id: 3, emoji: 'ğŸ’ª', name: 'Ãnimo', color: '#00c598', desc: 'Fuerzas para ti' },
  { id: 4, emoji: 'ğŸ“…', name: 'Planes', color: '#ffb800', desc: 'Quedamos?' },
  { id: 5, emoji: 'ğŸš¨', name: 'Urgente', color: '#ff5400', desc: 'Necesito ayuda' }
];

const COLORES = ['#8b5cf6', '#ff0066', '#00c598', '#0081ff', '#ffb800', '#ff5400'];
const ESTADOS = [
  { id: 'disponible', label: 'ğŸŸ¢ Disponible', color: '#48bb78' },
  { id: 'ocupado', label: 'ğŸ”´ Ocupado', color: '#ef4444' },
  { id: 'ausente', label: 'ğŸŸ¡ Ausente', color: '#f59e0b' }
];

// TODEX DATA
let todex = { captured: [], total_toques_enviados: 0, emojis_stats: {} };
try {
  todex = JSON.parse(localStorage.getItem("todex") || '{"captured": [], "total_toques_enviados": 0, "emojis_stats": {}}');
} catch(e) { todex = { captured: [], total_toques_enviados: 0, emojis_stats: {} }; }

const EMOJIS_DATABASE = [
{ id: 1, emoji: "ğŸ˜Š", name: "Sonrisa Radiante", rarity: "comun" },
{ id: 2, emoji: "â¤ï¸", name: "CorazÃ³n Rojo", rarity: "comun" },
{ id: 3, emoji: "ğŸ‘", name: "Like Ã‰pico", rarity: "comun" },
{ id: 4, emoji: "ğŸ”¥", name: "Fuego Intenso", rarity: "raro" },
{ id: 5, emoji: "ğŸ’¯", name: "Cien de Cien", rarity: "epico" },
{ id: 6, emoji: "ğŸ¤¥", name: "Mentiroso", rarity: "comun" },
{ id: 7, emoji: "ğŸ‘¾", name: "Pixel Juego", rarity: "raro" },
{ id: 8, emoji: "ğŸ’•", name: "Corazones Gemelos", rarity: "comun" },
{ id: 9, emoji: "ğŸš€", name: "Cohete Veloz", rarity: "raro" },
{ id: 10, emoji: "ğŸ¯", name: "Dardo Perfecto", rarity: "comun" },
{ id: 11, emoji: "ğŸ¦¾", name: "Brazo MecÃ¡nico", rarity: "comun" },
{ id: 12, emoji: "ğŸ™Œ", name: "Manos al Aire", rarity: "comun" },
{ id: 13, emoji: "ğŸ‘", name: "Aplauso Fuerte", rarity: "comun" },
{ id: 14, emoji: "ğŸ’‹", name: "Beso", rarity: "comun" },
{ id: 15, emoji: "ğŸ»", name: "Oso Pardo", rarity: "comun" },
{ id: 16, emoji: "ğŸ", name: "Abeja", rarity: "comun" },
{ id: 17, emoji: "ğŸŒˆ", name: "ArcoÃ­ris MÃ¡gico", rarity: "raro" },
{ id: 18, emoji: "â˜€ï¸", name: "Sol Radiante", rarity: "comun" },
{ id: 19, emoji: "ğŸŒ™", name: "Luna Creciente", rarity: "raro" },
{ id: 20, emoji: "â­", name: "Estrella Fugaz", rarity: "comun" },
{ id: 21, emoji: "ğŸŒ¸", name: "Flor de Cerezo", rarity: "raro" },
{ id: 22, emoji: "ğŸ“¸", name: "CÃ¡mara Flash", rarity: "comun" },
{ id: 23, emoji: "ğŸš—", name: "Coche Rojo", rarity: "comun" },
{ id: 24, emoji: "ğŸŒ·", name: "TulipÃ¡n Real", rarity: "raro" },
{ id: 25, emoji: "ğŸ€", name: "TrÃ©bol de la Suerte", rarity: "epico" },
{ id: 26, emoji: "ğŸ•", name: "Pizza Caliente", rarity: "comun" },
{ id: 27, emoji: "ğŸ‘…", name: "Lengua", rarity: "comun" },
{ id: 28, emoji: "ğŸŸ", name: "Papas Deluxe", rarity: "comun" },
{ id: 29, emoji: "ğŸŒ®", name: "Taco Dorado", rarity: "raro" },
{ id: 30, emoji: "ğŸ°", name: "Pastel de Cumple", rarity: "comun" },
{ id: 31, emoji: "ğŸ‚", name: "Torta MÃ¡gica", rarity: "raro" },
{ id: 32, emoji: "ğŸ«", name: "Chocolate Negro", rarity: "comun" },
{ id: 33, emoji: "â˜•", name: "CafÃ© EnergÃ­a", rarity: "comun" },
{ id: 34, emoji: "ğŸ¥¤", name: "Batido Guay", rarity: "comun" },
{ id: 35, emoji: "ğŸ€", name: "BalÃ³n de Oro", rarity: "raro" },
{ id: 36, emoji: "âš½", name: "Gol de Leyenda", rarity: "comun" },
{ id: 37, emoji: "ğŸ¾", name: "Ace Perfecto", rarity: "comun" },
{ id: 38, emoji: "ğŸ†", name: "Copa Suprema", rarity: "epico" },
{ id: 39, emoji: "ğŸ®", name: "Game Over", rarity: "comun" },
{ id: 40, emoji: "ğŸ²", name: "Dado Suerte", rarity: "raro" },
{ id: 41, emoji: "ğŸ¸", name: "Guitarra Rock", rarity: "raro" },
{ id: 42, emoji: "ğŸº", name: "Trompeta Jazz", rarity: "comun" },
{ id: 43, emoji: "ğŸ¨", name: "Pincel Arte", rarity: "comun" },
{ id: 44, emoji: "ğŸ“š", name: "Libro Sabio", rarity: "comun" },
{ id: 45, emoji: "ğŸ’¡", name: "Bombilla Idea", rarity: "epico" },
{ id: 46, emoji: "ğŸ”§", name: "Llave Maestra", rarity: "comun" },
{ id: 47, emoji: "ğŸ˜±", name: "Cara de Terror", rarity: "raro" },
{ id: 48, emoji: "ğŸ“±", name: "MÃ³vil Ãšltimo", rarity: "comun" },
{ id: 49, emoji: "ğŸ’»", name: "Laptop Gaming", rarity: "raro" },
{ id: 50, emoji: "ğŸ›¸", name: "Ovni", rarity: "epico" },
{ id: 51, emoji: "ğŸ¥·", name: "Ninja", rarity: "raro" },
{ id: 52, emoji: "ğŸ˜‡", name: "Angelito", rarity: "comun" },
{ id: 53, emoji: "ğŸ§Ÿâ€â™‚ï¸", name: "Zombie Chico", rarity: "raro" },
{ id: 54, emoji: "ğŸ‘½", name: "Alien", rarity: "epico" },
{ id: 55, emoji: "ğŸ©", name: "Sombrero MÃ¡gico", rarity: "raro" },
{ id: 56, emoji: "ğŸ§™", name: "Mago Anciano", rarity: "epico" },
{ id: 57, emoji: "ğŸ§š", name: "Hada Alas de Luz", rarity: "raro" },
{ id: 58, emoji: "ğŸ§œ", name: "Sirena del Mar", rarity: "epico" },
{ id: 59, emoji: "ğŸ’ƒğŸ»", name: "Bailarina", rarity: "mitico" },
{ id: 60, emoji: "ğŸ¦‹", name: "Mariposa Ã‰ter", rarity: "raro" },
{ id: 61, emoji: "ğŸ¦…", name: "Ãguila Celestial", rarity: "epico" },
{ id: 62, emoji: "ğŸ¦ˆ", name: "TiburÃ³n Noche", rarity: "raro" },
{ id: 63, emoji: "ğŸ…", name: "Tigre Diamante", rarity: "epico" },
{ id: 64, emoji: "ğŸ˜", name: "Elefante Estrella", rarity: "comun" },
{ id: 65, emoji: "ğŸ¦’", name: "Jirafa ArcoÃ­ris", rarity: "raro" },
{ id: 66, emoji: "ğŸ¦", name: "Rinoceronte Piedra", rarity: "comun" },
{ id: 67, emoji: "ğŸŒ", name: "Tierra MÃ¡gica", rarity: "epico" },
{ id: 68, emoji: "ğŸ“¦", name: "Caja Misteriosa", rarity: "raro" },
{ id: 69, emoji: "ğŸ´â€â˜ ï¸", name: "Bandera Pirata", rarity: "comun" },
{ id: 70, emoji: "âœ¨", name: "Brillo MÃ¡gico", rarity: "comun" },
{ id: 71, emoji: "ğŸš¨", name: "Alarma Roja", rarity: "comun" },
{ id: 72, emoji: "ğŸ‘‘", name: "Trono Real", rarity: "mitico" },
{ id: 73, emoji: "ğŸ¦„", name: "Unicornio Carmesi", rarity: "epico" },
{ id: 74, emoji: "ğŸ¦", name: "LeÃ³n Solar", rarity: "raro" },
{ id: 75, emoji: "ğŸ§Œ", name: "Trol", rarity: "mitico" },
{ id: 76, emoji: "ğŸ¦‰", name: "BÃºho Nocturno", rarity: "comun" },
{ id: 77, emoji: "ğŸ£", name: "Pollito", rarity: "epico" },
{ id: 78, emoji: "ğŸ‰", name: "DragÃ³n de Hielo", rarity: "mitico" },
{ id: 79, emoji: "ğŸ²", name: "DragÃ³n Joven", rarity: "epico" },
{ id: 80, emoji: "ğŸ¦•", name: "Dinosaurio Planta", rarity: "raro" },
{ id: 81, emoji: "ğŸ¦–", name: "T-Rex", rarity: "mitico" },
{ id: 82, emoji: "ğŸŒ‹", name: "VolcÃ¡n Activo", rarity: "epico" },
{ id: 83, emoji: "ğŸ—¿", name: "Cabeza Moai", rarity: "comun" },
{ id: 84, emoji: "ğŸª„", name: "Varita MÃ¡gica", rarity: "raro" },
{ id: 85, emoji: "âš¡", name: "Rayo Veloz", rarity: "comun" },
{ id: 86, emoji: "ğŸ’€", name: "Calacas Doradas", rarity: "legendario" },
{ id: 87, emoji: "ğŸ‘»", name: "Fantasma Joker", rarity: "epico" },
{ id: 88, emoji: "ğŸ¤¢", name: "Enfermo", rarity: "raro" },
{ id: 89, emoji: "ğŸ¤¡", name: "Payaso", rarity: "epico" },
{ id: 90, emoji: "ğŸª", name: "Circo", rarity: "comun" },
{ id: 91, emoji: "ğŸ¾", name: "ChampÃ¡n", rarity: "raro" },
{ id: 92, emoji: "ğŸ†", name: "Fuegos Artificio", rarity: "comun" },
{ id: 93, emoji: "ğŸ‡", name: "Chispa Divina", rarity: "epico" },
{ id: 94, emoji: "ğŸ«¶", name: "Manos CorazÃ³n", rarity: "comun" },
{ id: 95, emoji: "ğŸƒâ€â™‚ï¸", name: "Chico Futing", rarity: "comun" },
{ id: 96, emoji: "ğŸ§Ÿâ€â™€ï¸", name: "Zombie Chica", rarity: "raro" },
{ id: 97, emoji: "ğŸ¤–", name: "Robot", rarity: "comun" },
{ id: 98, emoji: "ğŸ§Š", name: "Cubito Hielo", rarity: "comun" },
{ id: 99, emoji: "ğŸ˜ˆ", name: "Demonio", rarity: "comun" },
{ id: 100, emoji: "ğŸ”«", name: "Pistola Agua", rarity: "epico" },
{ id: 101, emoji: "ğŸ’…", name: "Manicura", rarity: "comun" },
{ id: 102, emoji: "ğŸ", name: "Campanilla Viento", rarity: "comun" },
{ id: 103, emoji: "ğŸ€", name: "Lazo MÃ¡gico", rarity: "raro" },
{ id: 104, emoji: "ğŸ", name: "Caja Sorpresa", rarity: "comun" },
{ id: 105, emoji: "ğŸ°", name: "Tragaperras", rarity: "raro" },
{ id: 106, emoji: "âœˆï¸", name: "AviÃ³n", rarity: "comun" },
{ id: 107, emoji: "ğŸ¥µ", name: "Tengo Calor", rarity: "comun" },
{ id: 108, emoji: "ğŸ¥¶", name: "Congelado", rarity: "comun" },
{ id: 109, emoji: "âŒšï¸", name: "Reloj MuÃ±eca", rarity: "comun" },
{ id: 110, emoji: "âš“ï¸", name: "Ancla", rarity: "raro" },
{ id: 111, emoji: "ğŸ›", name: "BaÃ±era", rarity: "comun" },
{ id: 112, emoji: "ğŸª’", name: "MÃ¡quina Afeitar", rarity: "raro" },
{ id: 113, emoji: "ğŸª¤", name: "Trampa", rarity: "epico" },
{ id: 114, emoji: "ğŸ’£", name: "Bomba", rarity: "raro" },
{ id: 115, emoji: "ğŸï¸", name: "Moto Veloz", rarity: "comun" },
{ id: 116, emoji: "ğŸ’", name: "Cerezas", rarity: "comun" },
{ id: 117, emoji: "ğŸŒªï¸", name: "Tornado", rarity: "comun" },
{ id: 118, emoji: "ğŸ‘™", name: "Bikini", rarity: "epico" },
{ id: 119, emoji: "ğŸ§©", name: "Pieza Puzzle", rarity: "raro" },
{ id: 120, emoji: "ğŸª", name: "Cookie Choco", rarity: "comun" },
{ id: 121, emoji: "ğŸï¸", name: "F1", rarity: "epico" },
{ id: 122, emoji: "ğŸ“", name: "Graduado", rarity: "raro" },
{ id: 123, emoji: "ğŸ§¸", name: "Oso Peluche", rarity: "mitico" },
{ id: 124, emoji: "âœ‚ï¸", name: "Tijeras Cortar", rarity: "epico" },
{ id: 125, emoji: "ğŸ•³ï¸", name: "Agujero Profundo", rarity: "raro" },
{ id: 126, emoji: "â¤ï¸â€ğŸ”¥", name: "CorazÃ³n Llamas", rarity: "mitico" },
{ id: 127, emoji: "ğŸ¥³", name: "Fiestero", rarity: "epico" },
{ id: 128, emoji: "âš°ï¸", name: "AtaÃºd", rarity: "raro" },
{ id: 129, emoji: "ğŸˆ", name: "Globo Metalizado", rarity: "comun" },
{ id: 130, emoji: "ğŸ‰", name: "CelebraciÃ³n Total", rarity: "comun" },
{ id: 131, emoji: "ğŸ‘©ğŸ»â€â¤ï¸â€ğŸ‘¨", name: "Nuevos Novios", rarity: "epico" },
{ id: 132, emoji: "ğŸ¦Š", name: "Cara Zorro", rarity: "comun" },
{ id: 133, emoji: "ğŸ’¦", name: "Gotas", rarity: "comun" },
{ id: 134, emoji: "ğŸšª", name: "Puerta", rarity: "comun" },
{ id: 135, emoji: "ğŸ", name: "MuÃ±eca Emperatriz", rarity: "epico" },
{ id: 136, emoji: "âš ï¸", name: "SeÃ±al Peligro", rarity: "raro" },
{ id: 137, emoji: "ğŸ›Œ", name: "Dormido", rarity: "comun" },
{ id: 138, emoji: "ğŸ¤®", name: "Vomitando", rarity: "epico" },
{ id: 139, emoji: "ğŸ«¡", name: "A la Orden", rarity: "raro" },
{ id: 140, emoji: "ğŸ’", name: "Diamante Negro", rarity: "mitico" },
{ id: 141, emoji: "ğŸ›¹", name: "Skate", rarity: "epico" },
{ id: 142, emoji: "ğŸ’¸", name: "Dinero Volando", rarity: "raro" },
{ id: 143, emoji: "ğŸ’µ", name: "Billete Dorado", rarity: "comun" },
{ id: 144, emoji: "ğŸ’Š", name: "Pastilla", rarity: "comun" },
{ id: 145, emoji: "ğŸ’¶", name: "Euro Brillante", rarity: "comun" },
{ id: 146, emoji: "ğŸŸï¸", name: "Entrada Evento", rarity: "comun" },
{ id: 147, emoji: "âšœï¸", name: "Flor de Lis", rarity: "raro" },
{ id: 148, emoji: "ğŸ’³", name: "Tarjeta Platino", rarity: "epico" },
{ id: 149, emoji: "ğŸ’¿", name: "Disco Brillante", rarity: "legendario" },
{ id: 150, emoji: "ğŸ“€", name: "Disco Maestro", rarity: "legendario" }
];

// ========================================
// NAVEGACIÃ“N Y CONTROL
// ========================================

function showPage(pageName, saveHistory = true) {
  if (saveHistory && state.currentPage !== pageName) {
    state.history.push(state.currentPage);
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + pageName).classList.add('active');
  
  state.currentPage = pageName;
  state.focus = { type: 'none', index: 0 };
  
  // Inicializar foco segÃºn pÃ¡gina
  if (pageName === 'menu') {
    renderCarousel();
    state.focus = { type: 'carousel', index: state.menuIndex };
    updateFocus();
  } else if (pageName === 'tokes') {
    renderTokesList();
    state.focus = { type: 'list', index: 0 };
    updateFocus();
  } else if (pageName === 'contacts') {
    renderContacts();
    state.focus = { type: 'list', index: 0 };
    updateFocus();
  } else if (pageName === 'todox') {
    renderTodex();
    state.focus = { type: 'grid', index: 0 };
    updateFocus();
  } else if (pageName === 'combates') {
    state.focus = { type: 'combate', index: 0 };
    updateFocus();
  } else if (pageName === 'settings') {
    state.focus = { type: 'settings', index: 0 };
    updateSettingsUI();
    updateFocus();
  } else if (pageName === 'home') {
    updateHomeUI();
  }
  
  vibrar();
}

function goBack() {
  if (state.history.length > 0) {
    const prev = state.history.pop();
    showPage(prev, false);
  } else if (state.currentPage !== 'home') {
    showPage('home', false);
  }
}

// ========================================
// HANDLERS DE BOTONES FÃSICOS
// ========================================

function handleBack() {
  if (document.getElementById('response-modal').classList.contains('active')) {
    document.getElementById('response-modal').classList.remove('active');
    return;
  }
  goBack();
  vibrar();
}

function handleOK() {
  const page = state.currentPage;
  
  if (page === 'splash') {
    const nombre = localStorage.getItem('miNombre');
    if (nombre) {
      showPage('home');
    } else {
      showPage('setup');
    }
  } else if (page === 'setup') {
    const input = document.getElementById('miNombre');
    const nom = input.value.trim();
    if (!nom) {
      showMsg('Escribe tu nombre primero');
      return;
    }
    localStorage.setItem('miNombre', nom);
    generarQR();
    showPage('home');
  } else if (page === 'home') {
    showPage('menu');
  } else if (page === 'menu') {
    selectMenuItem(state.menuIndex);
  } else if (page === 'tokes') {
    selectTokeType(state.focus.index);
  } else if (page === 'contacts') {
    selectContact(state.focus.index);
  } else if (page === 'qr') {
    // nada, solo mostrar
  } else if (page === 'todox') {
    // Ver detalle si estÃ¡ capturado
    const id = state.focus.index + 1;
    if (todex.captured.includes(id)) {
      showEmojiDetail(id);
    }
  } else if (page === 'combates') {
    if (state.focus.index === 0) {
      jugarVSIA();
    } else {
      jugarVSAmigo();
    }
  } else if (page === 'settings') {
    activateSetting(state.focus.index);
  }
  
  vibrar();
}

function handleUp() {
  if (state.currentPage === 'tokes' || state.currentPage === 'contacts' || state.currentPage === 'settings') {
    if (state.focus.index > 0) {
      state.focus.index--;
      updateFocus();
      vibrar();
    }
  } else if (state.currentPage === 'todox') {
    if (state.focus.index >= 6) {
      state.focus.index -= 6;
      updateFocus();
      scrollToFocusedEmoji();
      vibrar();
    }
  } else if (state.currentPage === 'home') {
    showPage('menu');
  }
}

function handleDown() {
  const page = state.currentPage;
  
  if (page === 'menu') {
    showPage('home');
  } else if (page === 'tokes') {
    if (state.focus.index < TOKES_TYPES.length - 1) {
      state.focus.index++;
      updateFocus();
      vibrar();
    }
  } else if (page === 'contacts') {
    const max = Object.keys(contactos).length;
    if (state.focus.index < max - 1) {
      state.focus.index++;
      updateFocus();
      vibrar();
    }
  } else if (page === 'todox') {
    if (state.focus.index < 144) { // 150 - 6
      state.focus.index += 6;
      updateFocus();
      scrollToFocusedEmoji();
      vibrar();
    }
  } else if (page === 'settings') {
    if (state.focus.index < 4) {
      state.focus.index++;
      updateFocus();
      vibrar();
    }
  }
}

function handleLeft() {
  if (state.currentPage === 'menu') {
    if (state.menuIndex > 0) {
      state.menuIndex--;
      state.focus.index = state.menuIndex;
      renderCarousel();
      vibrar();
    }
  } else if (state.currentPage === 'todox') {
    if (state.focus.index % 6 > 0) {
      state.focus.index--;
      updateFocus();
      vibrar();
    }
  } else if (state.currentPage === 'combates') {
    if (state.focus.index > 0) {
      state.focus.index--;
      updateFocus();
      vibrar();
    }
  }
}

function handleRight() {
  if (state.currentPage === 'menu') {
    if (state.menuIndex < MENU_ITEMS.length - 1) {
      state.menuIndex++;
      state.focus.index = state.menuIndex;
      renderCarousel();
      vibrar();
    }
  } else if (state.currentPage === 'todox') {
    if (state.focus.index % 6 < 5 && state.focus.index < 149) {
      state.focus.index++;
      updateFocus();
      vibrar();
    }
  } else if (state.currentPage === 'combates') {
    if (state.focus.index < 1) {
      state.focus.index++;
      updateFocus();
      vibrar();
    }
  }
}

// ========================================
// RENDERIZADO Y UI
// ========================================

function renderCarousel() {
  const track = document.getElementById('carousel-track');
  track.innerHTML = '';
  
  // Mostrar 3 items: anterior, actual, siguiente
  const indices = [
    state.menuIndex - 1,
    state.menuIndex,
    state.menuIndex + 1
  ];
  
  indices.forEach((idx, pos) => {
    const btn = document.createElement('div');
    btn.className = 'carousel-btn';
    
    if (idx < 0 || idx >= MENU_ITEMS.length) {
      btn.className += ' hidden';
    } else {
      const item = MENU_ITEMS[idx];
      btn.innerHTML = `<span class="icon">${item.icon}</span><span>${item.label}</span>`;
      
      if (idx === state.menuIndex) {
        btn.className += ' focused';
      } else {
        btn.className += ' side';
      }
    }
    
    track.appendChild(btn);
  });
}

function renderTokesList() {
  const container = document.getElementById('tokes-list');
  container.innerHTML = '';
  
  TOKES_TYPES.forEach((tipo, idx) => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.dataset.index = idx;
    div.innerHTML = `
      <span class="emoji">${tipo.emoji}</span>
      <div style="flex: 1;">
        <div style="font-weight: 800;">${tipo.name}</div>
        <div style="font-size: 10px; color: #94a3b8; font-weight: 600;">${tipo.desc}</div>
      </div>
    `;
    container.appendChild(div);
  });
}

function renderContacts() {
  const container = document.getElementById('contacts-list');
  container.innerHTML = '';
  
  const lista = Object.entries(contactos);
  if (lista.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">No tienes amigos.<br>Ve a Escanear para aÃ±adir.</div>';
    return;
  }
  
  lista.forEach(([id, nom], idx) => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.dataset.index = idx;
    div.innerHTML = `
      <span class="emoji">ğŸ‘¤</span>
      <span>${nom}</span>
      <small style="color: #94a3b8;">${id}</small>
    `;
    container.appendChild(div);
  });
}

function renderTodex() {
  const grid = document.getElementById('todex-grid');
  grid.innerHTML = '';
  document.getElementById('todex-count').textContent = `${todex.captured.length}/150`;
  
  for (let i = 1; i <= 150; i++) {
    const card = document.createElement('div');
    card.className = 'emoji-card';
    card.dataset.index = i - 1;
    
    if (todex.captured.includes(i)) {
      card.classList.add('captured');
      card.textContent = EMOJIS_DATABASE[i-1].emoji;
    } else {
      card.textContent = 'â€¢';
      card.style.color = '#cbd5e1';
    }
    
    grid.appendChild(card);
  }
}

function updateFocus() {
  // Quitar foco anterior
  document.querySelectorAll('.focused').forEach(el => el.classList.remove('focused'));
  
  const { type, index } = state.focus;
  
  if (type === 'carousel') {
    renderCarousel(); // Re-render para actualizar clases
  } else if (type === 'list') {
    const items = document.querySelectorAll('.list-item');
    if (items[index]) items[index].classList.add('focused');
  } else if (type === 'grid') {
    const cards = document.querySelectorAll('.emoji-card');
    if (cards[index]) cards[index].classList.add('focused');
  } else if (type === 'combate') {
    const btns = document.querySelectorAll('.combate-btn');
    if (btns[index]) btns[index].classList.add('focused');
  } else if (type === 'settings') {
    const items = document.querySelectorAll('.setting-item');
    if (items[index]) items[index].classList.add('focused');
  }
}

function updateHomeUI() {
  const nom = localStorage.getItem('miNombre') || 'Usuario';
  document.getElementById('home-name').textContent = nom;
  document.getElementById('tokes-counter').textContent = `ğŸ¯ ${state.toquesRestantes}/30`;
  
  const status = ESTADOS.find(e => e.id === state.settings.status) || ESTADOS[0];
  const statusEl = document.getElementById('home-status');
  statusEl.textContent = status.label;
  statusEl.style.background = `linear-gradient(145deg, ${status.color}, ${adjustColor(status.color, -20)})`;
  statusEl.style.boxShadow = `0 3px 0 ${adjustColor(status.color, -40)}`;
}

function updateSettingsUI() {
  document.getElementById('toggle-sonido').classList.toggle('active', state.settings.sonido);
  document.getElementById('toggle-vibra').classList.toggle('active', state.settings.vibracion);
  document.getElementById('color-preview').style.background = COLORES[state.settings.colorIndex];
  const st = ESTADOS.find(e => e.id === state.settings.status);
  document.getElementById('status-preview').textContent = st ? st.label.split(' ')[1] : 'Disponible';
}

// ========================================
// ACCIONES
// ========================================

function selectMenuItem(index) {
  const item = MENU_ITEMS[index];
  
  if (item.id === 'scan') {
    scanQR();
  } else {
    showPage(item.id);
  }
}

function selectTokeType(index) {
  if (state.toquesRestantes <= 0) {
    showMsg('No te quedan tokes hoy');
    return;
  }
  
  state.selectedTokeType = TOKES_TYPES[index];
  showPage('contacts');
  showMsg(`Enviar: ${state.selectedTokeType.name}`);
}

function selectContact(index) {
  const lista = Object.entries(contactos);
  if (lista.length === 0) return;
  
  const [id, nom] = lista[index];
  enviarToque(id, nom);
}

async function enviarToque(paraId, paraNombre) {
  if (!state.selectedTokeType) return;
  
  try {
    const r = await fetch(`${BACK}/toque`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        de: miID,
        para: paraId,
        tipo: state.selectedTokeType.id,
        emoji: state.selectedTokeType.emoji,
        nombre: state.selectedTokeType.name
      })
    });
    
    const data = await r.json();
    if (data.ok) {
      state.toquesRestantes = data.toques_restantes || state.toquesRestantes - 1;
      localStorage.setItem('toquesRestantes', state.toquesRestantes);
      
      // Desbloquear emoji
      todex.total_toques_enviados++;
      if (todex.total_toques_enviados % 5 === 0) {
        desbloquearEmojiRandom();
      }
      localStorage.setItem('todex', JSON.stringify(todex));
      
      showMsg(`âœ… Toque ${state.selectedTokeType.emoji} a ${paraNombre}`);
      state.selectedTokeType = null;
      setTimeout(() => showPage('home'), 1500);
    }
  } catch(e) {
    showMsg('Error al enviar');
  }
}

function desbloquearEmojiRandom() {
  const disponibles = EMOJIS_DATABASE.map(e => e.id).filter(id => !todex.captured.includes(id));
  if (disponibles.length === 0) return;
  
  const nuevo = disponibles[Math.floor(Math.random() * disponibles.length)];
  todex.captured.push(nuevo);
  showMsg(`ğŸ‰ Â¡Nuevo emoji: ${EMOJIS_DATABASE[nuevo-1].emoji}!`);
}

function activateSetting(index) {
  switch(index) {
    case 0: // Sonido
      state.settings.sonido = !state.settings.sonido;
      localStorage.setItem('sonido', state.settings.sonido ? 'on' : 'off');
      showMsg(state.settings.sonido ? 'ğŸ”Š Sonido ON' : 'ğŸ”‡ Sonido OFF');
      break;
    case 1: // VibraciÃ³n
      state.settings.vibracion = !state.settings.vibracion;
      localStorage.setItem('vibracion', state.settings.vibracion ? 'on' : 'off');
      showMsg(state.settings.vibracion ? 'ğŸ“³ VibraciÃ³n ON' : 'ğŸ“³ VibraciÃ³n OFF');
      break;
    case 2: // Color
      state.settings.colorIndex = (state.settings.colorIndex + 1) % COLORES.length;
      localStorage.setItem('colorIndex', state.settings.colorIndex);
      const color = COLORES[state.settings.colorIndex];
      document.documentElement.style.setProperty('--device-color', color);
      showMsg('ğŸ¨ Color cambiado');
      break;
    case 3: // Estado
      const idx = ESTADOS.findIndex(e => e.id === state.settings.status);
      const next = ESTADOS[(idx + 1) % ESTADOS.length];
      state.settings.status = next.id;
      localStorage.setItem('status', next.id);
      showMsg(next.label);
      break;
    case 4: // Reiniciar
      if (confirm('Â¿Borrar TODO?')) {
        localStorage.clear();
        location.reload();
      }
      break;
  }
  updateSettingsUI();
}

// ========================================
// QR Y ESCANER
// ========================================

function generarQR() {
  const nom = localStorage.getItem('miNombre') || 'Usuario';
  const texto = `${miID}|${nom}`;
  document.getElementById('qr-mio').innerHTML = 
    `<img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(texto)}" alt="QR"/>`;
}

function scanQR() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'scanner';
  modal.innerHTML = `
    <div style="text-align:center; background: white; padding: 20px; border-radius: 20px; max-width: 90%;">
      <h3 style="margin-bottom: 15px; color: #333;">ğŸ“· Escanea un QR</h3>
      <video id="video" style="width:100%; max-width: 300px; border: 3px solid #8b5cf6; border-radius: 15px;"></video>
      <br>
      <button onclick="closeScanner()" style="margin-top: 15px; padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 10px; font-weight: 700;">Cerrar</button>
    </div>
  `;
  document.body.appendChild(modal);
  
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      const video = document.getElementById('video');
      video.srcObject = stream;
      video.play();
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      function scan() {
        if (!document.getElementById('video')) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
        if (code) {
          stream.getTracks().forEach(t => t.stop());
          modal.remove();
          procesarQR(code.data);
        } else {
          requestAnimationFrame(scan);
        }
      }
      scan();
    })
    .catch(() => {
      alert('No se pudo acceder a la cÃ¡mara');
      modal.remove();
    });
}

function closeScanner() {
  const modal = document.getElementById('scanner');
  if (modal) {
    const video = modal.querySelector('video');
    if (video && video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
    }
    modal.remove();
  }
}

function procesarQR(data) {
  const [id, nombre] = data.split('|');
  if (id && nombre && id !== miID) {
    contactos[id] = nombre;
    localStorage.setItem('cts', JSON.stringify(contactos));
    showMsg(`âœ… ${nombre} aÃ±adido`);
    showPage('contacts');
  } else {
    showMsg('QR invÃ¡lido o es el tuyo');
  }
}

// ========================================
// COMBATES (SIMPLIFICADOS)
// ========================================

function jugarVSIA() {
  if (todex.captured.length < 3) {
    showMsg('Necesitas 3 emojis');
    return;
  }
  showMsg('ğŸ¤– VS IA - PrÃ³ximamente');
}

function jugarVSAmigo() {
  if (Object.keys(contactos).length === 0) {
    showMsg('AÃ±ade amigos primero');
    return;
  }
  showMsg('âš”ï¸ VS Amigo - PrÃ³ximamente');
}

// ========================================
// RESPUESTAS A TOQUES
// ========================================

function mostrarToqueRecibido(toque) {
  state.pendingToque = toque;
  const modal = document.getElementById('response-modal');
  const nombre = contactos[toque.de] || 'Alguien';
  document.getElementById('response-title').textContent = `${toque.emoji} Toque de ${nombre}`;
  
  modal.classList.add('active');
  
  // Reset focus en modal
  state.focus = { type: 'response', index: 0 };
  updateResponseFocus();
}

function updateResponseFocus() {
  document.querySelectorAll('.response-btn, .response-action-btn').forEach(el => el.classList.remove('focused'));
  
  if (state.focus.index < 4) {
    document.querySelectorAll('.response-btn')[state.focus.index].classList.add('focused');
  } else if (state.focus.index === 4) {
    document.querySelector('[data-action="ignore"]').classList.add('focused');
  } else {
    document.querySelector('[data-action="send"]').classList.add('focused');
  }
}

function handleResponseOK() {
  const idx = state.focus.index;
  const modal = document.getElementById('response-modal');
  
  if (idx === 4) { // Ignorar
    modal.classList.remove('active');
    state.pendingToque = null;
  } else if (idx === 5 || idx < 4) { // Responder
    const respuestas = ['ğŸ’•', 'ğŸ˜‚', 'ğŸ™', 'ğŸ”¥'];
    const respuesta = idx < 4 ? respuestas[idx] : respuestas[0];
    
    // Enviar respuesta al servidor
    fetch(`${BACK}/respuesta`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        de: miID,
        para: state.pendingToque.de,
        respuesta: respuesta
      })
    }).catch(() => {});
    
    showMsg(`Respondiste ${respuesta}`);
    modal.classList.remove('active');
    state.pendingToque = null;
  }
}

// Override handleOK para modal de respuesta
const originalHandleOK = handleOK;
handleOK = function() {
  if (document.getElementById('response-modal').classList.contains('active')) {
    handleResponseOK();
    return;
  }
  originalHandleOK();
};

// Override direccionales para modal
const originalHandleUp = handleUp;
const originalHandleDown = handleDown;
const originalHandleLeft = handleLeft;
const originalHandleRight = handleRight;

handleUp = function() {
  if (document.getElementById('response-modal').classList.contains('active')) {
    if (state.focus.index >= 2) {
      state.focus.index -= 2;
      updateResponseFocus();
      vibrar();
    }
    return;
  }
  originalHandleUp();
};

handleDown = function() {
  if (document.getElementById('response-modal').classList.contains('active')) {
    if (state.focus.index < 4) {
      state.focus.index += 2;
      if (state.focus.index > 5) state.focus.index = 5;
      updateResponseFocus();
      vibrar();
    }
    return;
  }
  originalHandleDown();
};

handleLeft = function() {
  if (document.getElementById('response-modal').classList.contains('active')) {
    if (state.focus.index > 0 && state.focus.index !== 4) {
      state.focus.index--;
      updateResponseFocus();
      vibrar();
    } else if (state.focus.index === 5) {
      state.focus.index = 4;
      updateResponseFocus();
      vibrar();
    }
    return;
  }
  originalHandleLeft();
};

handleRight = function() {
  if (document.getElementById('response-modal').classList.contains('active')) {
    if (state.focus.index < 3) {
      state.focus.index++;
      updateResponseFocus();
      vibrar();
    } else if (state.focus.index === 4) {
      state.focus.index = 5;
      updateResponseFocus();
      vibrar();
    }
    return;
  }
  originalHandleRight();
};

// ========================================
// UTILIDADES
// ========================================

function showMsg(text) {
  const bar = document.getElementById('msg-bar');
  bar.textContent = text;
  bar.classList.add('show');
  setTimeout(() => bar.classList.remove('show'), 2500);
}

function vibrar() {
  if (state.settings.vibracion && navigator.vibrate) {
    navigator.vibrate(10);
  }
}

function scrollToFocusedEmoji() {
  const cards = document.querySelectorAll('.emoji-card');
  if (cards[state.focus.index]) {
    cards[state.focus.index].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }
}

function showEmojiDetail(id) {
  const emoji = EMOJIS_DATABASE[id-1];
  showMsg(`${emoji.emoji} ${emoji.name}`);
}

function adjustColor(color, amount) {
  const num = parseInt(color.replace('#', ''), 16);
  const r = Math.max(0, Math.min(255, (num >> 16) + amount));
  const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
  const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
  return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
}

// ========================================
// INICIALIZACIÃ“N
// ========================================

function init() {
  // Aplicar color guardado
  const color = COLORES[state.settings.colorIndex];
  document.documentElement.style.setProperty('--device-color', color);
  
  // Reloj
  setInterval(() => {
    const now = new Date();
    document.getElementById('clock').textContent = 
      String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  }, 60000);
  
  // Verificar toques recibidos
  setInterval(verificarToquesRecibidos, 8000);
  
  // Generar QR si existe nombre
  if (localStorage.getItem('miNombre')) {
    generarQR();
  }
  
  // Reset toques diarios
  const lastReset = localStorage.getItem('lastReset');
  const hoy = new Date().toDateString();
  if (lastReset !== hoy) {
    state.toquesRestantes = 30;
    localStorage.setItem('toquesRestantes', 30);
    localStorage.setItem('lastReset', hoy);
  }
}

async function verificarToquesRecibidos() {
  if (state.currentPage === 'splash' || state.currentPage === 'setup') return;
  
  try {
    const r = await fetch(`${BACK}/toques-pendientes?userId=${miID}`);
    const data = await r.json();
    if (data.ok && data.toques.length > 0) {
      // Mostrar el primero
      mostrarToqueRecibido(data.toques[0]);
    }
  } catch(e) {}
}

// Iniciar
init();
</script>
</body>
</html>
