<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Tokeji ‚ú® DEBUG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
  <meta name="theme-color" content="#FF6B9D"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    
    :root {
      --device-color: #FF6B9D;
      --device-dark: #FF4785;
      --screen-bg: #FFF5F7;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
      font-family: 'Nunito', sans-serif;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    .device {
      width: 340px;
      height: 600px;
      background: linear-gradient(145deg, #FFB8D0 0%, var(--device-color) 50%, var(--device-dark) 100%);
      border-radius: 40px;
      padding: 25px 15px 15px 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      position: relative;
      display: flex;
      flex-direction: column;
      border: 3px solid rgba(255,255,255,0.2);
      margin: auto;
    }

    .screw {
      position: absolute;
      width: 12px;
      height: 12px;
      background: linear-gradient(145deg, #E8E8E8, #A0A0A0);
      border-radius: 50%;
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .screw::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); width: 6px; height: 2px; background: #666; box-shadow: 0 0 0 1px #666; }
    .screw-tl { top: 12px; left: 15px; }
    .screw-tr { top: 12px; right: 15px; }
    .screw-bl { bottom: 100px; left: 15px; }
    .screw-br { bottom: 100px; right: 15px; }

    .device-logo { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); font-family: 'Fredoka One', cursive; font-size: 11px; color: rgba(255,255,255,0.9); letter-spacing: 2px; z-index: 5; }

    .screen-container { width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; margin-top: 8px; margin-bottom: 8px; }

    .screen {
      width: 100%;
      height: 380px;
      background: var(--screen-bg);
      border-radius: 22px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
      border: 4px solid #2D3748;
      display: flex;
      flex-direction: column;
    }

    .status-bar { position: absolute; top: 8px; left: 12px; right: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; font-weight: 800; color: #718096; z-index: 10; font-family: 'Fredoka One', cursive; }

    .content { flex: 1; padding: 28px 12px 12px; display: flex; flex-direction: column; align-items: center; overflow: hidden; position: relative; }

    .page { display: none; width: 100%; height: 100%; flex-direction: column; }
    .page.active { display: flex; }

    #page-splash { justify-content: center; align-items: center; text-align: center; background: linear-gradient(145deg, var(--device-color), #FFB8D0); height: 100%; width: 100%; padding: 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 18px; }
    .splash-logo { font-family: 'Fredoka One', cursive; font-size: 52px; color: white; text-shadow: 0 4px 0 var(--device-dark), 0 6px 10px rgba(0,0,0,0.2); animation: pulse-logo 2s ease-in-out infinite; margin-bottom: 20px; }
    @keyframes pulse-logo { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.9; } }
    .splash-hint { position: absolute; bottom: 50px; font-size: 14px; color: rgba(255,255,255,0.9); animation: blink 1.5s infinite; font-weight: 700; }
    @keyframes blink { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

    #page-consent { justify-content: center; align-items: center; background: var(--screen-bg); height: 100%; width: 100%; padding: 20px; text-align: center; }
    .consent-title { font-family: 'Fredoka One', cursive; font-size: 20px; color: #2D3748; margin-bottom: 15px; }
    .consent-text { font-size: 12px; color: #4A5568; line-height: 1.5; margin-bottom: 20px; max-width: 260px; }
    .consent-buttons { display: flex; gap: 12px; width: 100%; max-width: 220px; }
    .consent-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 800; cursor: pointer; transition: all 0.1s ease; box-shadow: 0 3px 0 rgba(0,0,0,0.2); }
    .consent-btn.no { background: #E2E8F0; color: #4A5568; box-shadow: 0 3px 0 #CBD5E0; }
    .consent-btn.si { background: #48BB78; color: white; box-shadow: 0 3px 0 #38A169; }
    .consent-btn.focused { transform: scale(1.05); box-shadow: 0 0 0 3px rgba(255,107,157,0.3); }

    #page-setup { justify-content: center; align-items: center; background: var(--screen-bg); height: 100%; width: 100%; padding: 20px; }
    .setup-title { font-family: 'Fredoka One', cursive; font-size: 20px; color: #2D3748; margin-bottom: 25px; text-align: center; }
    .setup-input { width: 100%; max-width: 260px; padding: 14px; border: 3px solid #FFD93D; border-radius: 14px; font-size: 22px; text-align: center; text-transform: uppercase; font-weight: 800; background: white; outline: none; font-family: 'Nunito', sans-serif; -webkit-appearance: none; margin-bottom: 15px; }
    .setup-hint { font-size: 12px; color: #A0AEC0; }

    #page-avatar { justify-content: flex-start; align-items: center; background: var(--screen-bg); height: 100%; width: 100%; padding: 30px 20px 20px 20px; }
    .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; width: 100%; max-width: 280px; margin-top: 10px; }
    .avatar-item { aspect-ratio: 1; background: white; border: 3px solid #E2E8F0; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; transition: all 0.1s ease; box-shadow: 0 3px 0 #CBD5E0; }
    .avatar-item:active { transform: translateY(3px); box-shadow: 0 0 0 #CBD5E0; }
    .avatar-item.focused { border-color: var(--device-color); background: #FFF5F7; transform: scale(1.1); box-shadow: 0 0 0 3px rgba(255,107,157,0.3); }

    #page-color { justify-content: flex-start; align-items: center; background: var(--screen-bg); height: 100%; width: 100%; padding: 30px 20px 20px 20px; }
    .color-setup-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 200px; margin-top: 10px; }
    .color-setup-item { aspect-ratio: 1; border: 4px solid white; border-radius: 16px; cursor: pointer; transition: all 0.1s ease; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
    .color-setup-item:active { transform: translateY(4px); box-shadow: 0 0 0 rgba(0,0,0,0.2); }
    .color-setup-item.focused { transform: scale(1.1); box-shadow: 0 0 0 4px rgba(255,255,255,0.8), 0 4px 0 rgba(0,0,0,0.2); }

    .home-main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
    .home-avatar { font-size: 60px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15)); animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    .home-name { font-family: 'Fredoka One', cursive; font-size: 22px; color: #2D3748; }
    .home-status { font-size: 11px; padding: 5px 14px; border-radius: 20px; font-weight: 800; color: white; background: #48BB78; box-shadow: 0 2px 0 #2F855A; }
    .tokes-badge { background: #ECC94B; color: #744210; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 800; margin-top: 6px; box-shadow: 0 2px 0 #B7791F; }

    .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, 1fr); gap: 10px; width: 100%; height: 100%; padding: 0 5px; }
    .menu-item { background: #ffffff; border: 3px solid #E2E8F0; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; font-size: 12px; font-weight: 800; color: #4A5568; transition: all 0.1s ease; cursor: pointer; box-shadow: 0 3px 0 #CBD5E0; min-height: 0; }
    .menu-item:active { transform: translateY(3px) scale(0.98); box-shadow: 0 0 0 #CBD5E0; }
    .menu-item.focused { border-color: var(--device-color); background: #FFF5F7; transform: scale(1.02); box-shadow: 0 0 0 3px rgba(255,107,157,0.3); z-index: 10; }
    .menu-item .icon { font-size: 32px; transition: transform 0.2s; }
    .menu-item.focused .icon { transform: scale(1.1); }

    .list-container { width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 0 5px 5px 5px; -webkit-overflow-scrolling: touch; }

    .list-item, .toke-item, .variante-item { background: white; border: 2px solid #E2E8F0; border-radius: 14px; padding: 12px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 10px; transition: all 0.1s ease; box-shadow: 0 2px 0 #E2E8F0; flex-shrink: 0; min-height: 54px; cursor: pointer; }
    .list-item.focused, .toke-item.focused, .variante-item.focused { border-color: var(--device-color); background: #FFF5F7; transform: translateX(3px); box-shadow: 0 2px 0 #F687B3; }

    .toke-item.t1 { border-color: #FF0066; background: #FFF0F3; }
    .toke-item.t1.focused { box-shadow: 0 2px 0 #CC0052; }
    .toke-item.t2 { border-color: #FF5400; background: #FFF4F0; }
    .toke-item.t2.focused { box-shadow: 0 2px 0 #CC4400; }
    .toke-item.t3 { border-color: #38A169; background: #F0FFF4; }
    .toke-item.t3.focused { box-shadow: 0 2px 0 #276749; }
    .toke-item.t4 { border-color: #D69E2E; background: #FFFBEB; }
    .toke-item.t4.focused { box-shadow: 0 2px 0 #B7791F; }
    .toke-item.t5 { border-color: #3182CE; background: #EBF8FF; }
    .toke-item.t5.focused { box-shadow: 0 2px 0 #2C5282; }

    .variante-item { border-left: 4px solid; }
    .variante-item.v1 { border-left-color: #FF0066; }
    .variante-item.v2 { border-left-color: #FF5400; }
    .variante-item.v3 { border-left-color: #38A169; }
    .variante-item.v4 { border-left-color: #D69E2E; }
    .variante-item.v5 { border-left-color: #3182CE; }

    .scan-btn { background: #805AD5; color: white; border: none; border-radius: 14px; padding: 14px; font-size: 13px; font-weight: 800; margin-bottom: 10px; box-shadow: 0 3px 0 #6B46C1; transition: all 0.1s ease; flex-shrink: 0; width: 100%; cursor: pointer; -webkit-appearance: none; }
    .scan-btn:active { transform: translateY(3px); box-shadow: 0 0 0 #6B46C1; }
    .scan-btn.focused { transform: scale(1.01); box-shadow: 0 0 0 3px rgba(159,122,234,0.3), 0 3px 0 #6B46C1; }

    .qr-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #qr-mio { background: white; padding: 16px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 3px solid #FFD93D; }
    #qr-mio img { width: 140px; height: 140px; display: block; }

    .todex-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; flex: 1; overflow-y: auto; padding: 0 5px 5px 5px; }
    .emoji-card { aspect-ratio: 1; background: #EDF2F7; border: 2px solid transparent; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.1s ease; }
    .emoji-card.captured { background: #48BB78; border-color: #276749; color: white; }
    .emoji-card.focused { border-color: var(--device-color); transform: scale(1.1); box-shadow: 0 0 8px rgba(255,107,157,0.4); z-index: 10; }

    .envio-info { background: #FFF5F7; border: 2px solid var(--device-color); border-radius: 12px; padding: 10px; margin-bottom: 10px; font-size: 11px; text-align: center; color: #2D3748; font-weight: 700; }
    .envio-info strong { color: var(--device-color); font-size: 13px; }

    .btn-eliminar { background: #F56565; color: white; border: none; border-radius: 8px; padding: 6px 12px; font-size: 11px; font-weight: 800; cursor: pointer; box-shadow: 0 2px 0 #C53030; min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center; -webkit-appearance: none; }
    .btn-eliminar:active { transform: translateY(2px); box-shadow: 0 0 0 #C53030; }

    .selector-modal { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: flex-start; padding: 30px 20px 20px 20px; z-index: 100; overflow-y: auto; }
    .selector-modal.active { display: flex; }
    .selector-title { color: white; font-family: 'Fredoka One', cursive; font-size: 18px; margin-bottom: 20px; text-align: center; flex-shrink: 0; }
    .selector-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 240px; padding-bottom: 20px; }
    .selector-item { aspect-ratio: 1; border: 3px solid transparent; border-radius: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; transition: all 0.1s ease; cursor: pointer; color: white; padding: 10px; min-height: 90px; max-height: 100px; }
    .selector-item.focused { border-color: white; transform: scale(1.05); box-shadow: 0 0 15px rgba(255,255,255,0.5); }

    .toque-recibido-modal { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(145deg, rgba(0,197,152,0.95), rgba(0,221,170,0.95)); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; z-index: 150; text-align: center; color: white; }
    .toque-recibido-modal.active { display: flex; }
    .toque-recibido-modal .emoji-big { font-size: 80px; margin-bottom: 20px; animation: bounce 0.6s infinite alternate; }
    @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.2); } }
    .toque-recibido-modal .nombre { font-family: 'Fredoka One', cursive; font-size: 24px; margin-bottom: 10px; }
    .toque-recibido-modal .mensaje { font-size: 16px; margin-bottom: 30px; padding: 0 20px; }
    .toque-recibido-modal .btn-cerrar { background: white; color: #00c598; border: none; padding: 15px 40px; border-radius: 30px; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }

    .confirm-modal { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 25px; z-index: 200; }
    .confirm-modal.active { display: flex; }
    .confirm-box { background: white; border-radius: 20px; padding: 25px; width: 100%; max-width: 260px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .confirm-title { font-family: 'Fredoka One', cursive; font-size: 20px; color: #E53E3E; margin-bottom: 12px; }
    .confirm-text { font-size: 13px; color: #4A5568; margin-bottom: 20px; line-height: 1.5; }
    .confirm-buttons { display: flex; gap: 10px; }
    .confirm-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 800; cursor: pointer; transition: all 0.1s ease; -webkit-appearance: none; }
    .confirm-btn.no { background: #E2E8F0; color: #4A5568; box-shadow: 0 3px 0 #CBD5E0; }
    .confirm-btn.no:active { transform: translateY(3px); box-shadow: 0 0 0 #CBD5E0; }
    .confirm-btn.si { background: #F56565; color: white; box-shadow: 0 3px 0 #C53030; }
    .confirm-btn.si:active { transform: translateY(3px); box-shadow: 0 0 0 #C53030; }
    .confirm-btn.focused { transform: scale(1.03); box-shadow: 0 0 0 3px rgba(255,107,157,0.3); }

    .controls { margin-top: 3px; display: flex; flex-direction: column; align-items: center; gap: 8px; padding-bottom: 3px; }
    .controls-row { display: flex; align-items: center; gap: 15px; }

    .btn-candy { border: none; font-family: 'Fredoka One', cursive; cursor: pointer; transition: all 0.08s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 0 rgba(0,0,0,0.2); -webkit-appearance: none; }
    .btn-candy:active { transform: translateY(3px); box-shadow: 0 0 0 rgba(0,0,0,0.2); }
    .btn-back { width: 50px; height: 38px; background: #4299E1; border-radius: 19px; color: white; font-size: 11px; }
    .btn-ok { width: 65px; height: 48px; background: #48BB78; border-radius: 24px; color: white; font-size: 16px; box-shadow: 0 4px 0 #38A169; }
    .btn-ok:active { box-shadow: 0 0 0 #38A169; }

    .dpad { display: grid; grid-template-columns: repeat(3, 38px); grid-template-rows: repeat(3, 38px); gap: 3px; }
    .dpad-btn { width: 38px; height: 38px; background: #D69E2E; border-radius: 10px; color: #744210; font-size: 16px; border: none; cursor: pointer; box-shadow: 0 2px 0 #B7791F; -webkit-appearance: none; transition: all 0.08s ease; }
    .dpad-btn:active { transform: translateY(2px); box-shadow: 0 0 0 #B7791F; }
    .dpad-empty { visibility: hidden; }

    .msg-bar { position: absolute; bottom: 0; left: 0; right: 0; background: var(--device-color); color: white; padding: 10px; font-size: 12px; font-weight: 800; text-align: center; transform: translateY(100%); transition: transform 0.3s ease; font-family: 'Nunito', sans-serif; z-index: 20; }
    .msg-bar.show { transform: translateY(0); }

    .debug-info { position: fixed; top: 5px; left: 5px; right: 5px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; font-family: monospace; font-size: 10px; border-radius: 8px; z-index: 9999; max-height: 150px; overflow-y: auto; display: none; }
    .debug-info.show { display: block; }

    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-thumb { background: #F687B3; border-radius: 2px; }
    ::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body>
  <div class="debug-info" id="debug-info"></div>

  <div class="device" id="device">
    <div class="screw screw-tl"></div>
    <div class="screw screw-tr"></div>
    <div class="screw screw-bl"></div>
    <div class="screw screw-br"></div>
    
    <div class="device-logo">‚ú® TOKEJI ‚ú®</div>
    
    <div class="screen-container">
      <div class="screen">
        <div class="status-bar">
          <span id="debug-btn" style="cursor:pointer;">üîß</span>
          <span id="clock">12:00</span>
        </div>

        <div class="content">
          <div class="page active" id="page-splash">
            <div class="splash-logo">TOKEJI</div>
            <div class="splash-hint">Pulsa OK ‚ú®</div>
          </div>

          <div class="page" id="page-consent">
            <div class="consent-title">üìã Bienvenido</div>
            <div class="consent-text">
              Tokeji es una experiencia social donde compartes mensajes con amigos mediante c√≥digos QR.
            </div>
            <div class="consent-buttons">
              <button class="consent-btn no focused" onclick="app.handleConsent(false)">No</button>
              <button class="consent-btn si" onclick="app.handleConsent(true)">S√≠</button>
            </div>
          </div>

          <div class="page" id="page-setup">
            <div class="setup-title">¬øC√≥mo te llamas?</div>
            <input type="text" id="miNombre" class="setup-input" maxlength="8" placeholder="TU NOMBRE" autocomplete="off" autocapitalize="characters">
            <div class="setup-hint">Pulsa OK para continuar</div>
          </div>

          <div class="page" id="page-avatar">
            <div class="setup-title">Elige tu avatar</div>
            <div class="avatar-grid" id="avatar-grid"></div>
          </div>

          <div class="page" id="page-color">
            <div class="setup-title">Elige tu color</div>
            <div class="color-setup-grid" id="color-setup-grid"></div>
          </div>

          <div class="page" id="page-home">
            <div class="home-main">
              <div class="home-avatar" id="home-avatar">üê±</div>
              <div class="home-name" id="home-name">Amigo</div>
              <div class="home-status" id="home-status">üü¢ Disponible</div>
              <div class="tokes-badge" id="tokes-badge">üéØ 30/30</div>
            </div>
          </div>

          <div class="page" id="page-menu">
            <div class="setup-title">Men√∫</div>
            <div class="menu-grid" id="menu-grid">
              <div class="menu-item focused" data-index="0"><span class="icon">üíå</span><span>Tokes</span></div>
              <div class="menu-item" data-index="1"><span class="icon">üë•</span><span>Amigos</span></div>
              <div class="menu-item" data-index="2"><span class="icon">üì±</span><span>Mi QR</span></div>
              <div class="menu-item" data-index="3"><span class="icon">üìñ</span><span>ToDox</span></div>
              <div class="menu-item" data-index="4"><span class="icon">‚öôÔ∏è</span><span>Ajustes</span></div>
              <div class="menu-item" data-index="5"><span class="icon">üß™</span><span>Test</span></div>
            </div>
          </div>

          <div class="page" id="page-tokes">
            <div class="setup-title">Elige Categor√≠a</div>
            <div class="list-container" id="tokes-list"></div>
          </div>

          <div class="page" id="page-variantes">
            <div class="setup-title" id="variantes-title">Variante</div>
            <div class="list-container" id="variantes-list"></div>
          </div>

          <div class="page" id="page-enviar">
            <div class="setup-title">Enviar a...</div>
            <div class="envio-info" id="envio-info">Enviando: <strong id="toke-seleccionado">-</strong></div>
            <div class="list-container" id="enviar-list"></div>
          </div>

          <div class="page" id="page-contacts">
            <div class="setup-title">Amigos</div>
            <button class="scan-btn focused" id="scan-btn">üì∑ Escanear QR</button>
            <div class="list-container" id="contacts-list"></div>
          </div>

          <div class="page" id="page-qr">
            <div class="setup-title">Mi C√≥digo QR</div>
            <div class="qr-container">
              <div id="qr-mio"></div>
              <div style="font-size: 11px; color: #718096; margin-top: 10px;">Escanea para agregar</div>
            </div>
          </div>

          <div class="page" id="page-todox">
            <div class="setup-title">ToDox <span style="color: var(--device-color);" id="todex-count">0/150</span></div>
            <div class="todex-grid" id="todex-grid"></div>
          </div>

          <div class="page" id="page-settings">
            <div class="setup-title">‚öôÔ∏è Ajustes</div>
            <div class="settings-list" id="settings-list">
              <div class="setting-item focused" data-index="0"><span>üîä Sonido</span><div class="toggle-switch active" id="toggle-sonido"></div></div>
              <div class="setting-item" data-index="1"><span>üì≥ Vibraci√≥n</span><div class="toggle-switch active" id="toggle-vibra"></div></div>
              <div class="setting-item" data-index="2"><span>üé® Color</span><div id="color-preview" style="width: 24px; height: 24px; background: #FF6B9D; border-radius: 50%; border: 2px solid white;"></div></div>
              <div class="setting-item" data-index="3" style="color: #E53E3E;"><span>üóëÔ∏è Reiniciar</span></div>
            </div>
          </div>

          <div class="page" id="page-test">
            <div class="setup-title">üß™ Test Backend</div>
            <div class="list-container" style="padding: 20px;">
              <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; font-size: 12px;">
                <div style="font-weight: bold; margin-bottom: 5px;">Backend URL:</div>
                <div id="test-url" style="color: #666; word-break: break-all;"></div>
              </div>
              <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; font-size: 12px;">
                <div style="font-weight: bold; margin-bottom: 5px;">Mi ID:</div>
                <div id="test-id" style="color: #666; word-break: break-all;"></div>
              </div>
              <button onclick="app.testBackend()" style="width: 100%; padding: 15px; background: #48BB78; color: white; border: none; border-radius: 12px; font-weight: bold; margin-bottom: 10px;">üß™ Test Conexi√≥n</button>
              <button onclick="app.testEnviarToque()" style="width: 100%; padding: 15px; background: #4299E1; color: white; border: none; border-radius: 12px; font-weight: bold;">üì§ Test Enviar Toque</button>
            </div>
          </div>

          <div class="selector-modal" id="color-selector">
            <div class="selector-title">üé® Elige color</div>
            <div class="selector-grid" id="color-grid"></div>
          </div>

          <div class="toque-recibido-modal" id="toque-recibido-modal">
            <div class="emoji-big" id="toque-emoji">üéâ</div>
            <div class="nombre" id="toque-nombre">Alguien</div>
            <div class="mensaje" id="toque-mensaje">Te envi√≥ un toque</div>
            <button class="btn-cerrar" onclick="app.cerrarToqueRecibido()">¬°Genial!</button>
          </div>

          <div class="confirm-modal" id="confirm-reiniciar">
            <div class="confirm-box">
              <div class="confirm-title">üóëÔ∏è ¬øReiniciar?</div>
              <div class="confirm-text">Se borrar√°n todos tus datos. ¬øEst√°s seguro?</div>
              <div class="confirm-buttons">
                <button class="confirm-btn no focused" onclick="app.cancelarReinicio()">No</button>
                <button class="confirm-btn si" onclick="app.confirmarReinicio()">S√≠, borrar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="msg-bar" id="msg-bar"></div>
      </div>
    </div>

    <div class="controls">
      <div class="controls-row">
        <button class="btn-candy btn-back" onclick="app.handleBack()">‚óÑ</button>
        <button class="btn-candy btn-ok" onclick="app.handleOK()">OK</button>
        <div class="dpad">
          <div class="dpad-empty"></div>
          <button class="dpad-btn" onclick="app.handleUp()">‚ñ≤</button>
          <div class="dpad-empty"></div>
          <button class="dpad-btn" onclick="app.handleLeft()">‚óÑ</button>
          <button class="dpad-btn" onclick="app.handleDown()">‚ñº</button>
          <button class="dpad-btn" onclick="app.handleRight()">‚ñ∫</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
// ========================================
// TOKEJI v11 - DEBUG VERSION
// ========================================

// ‚úÖ URL DEL BACKEND - SIN ESPACIOS
const BACK = "https://dame-un-toque-1.onrender.com";

const CONTEXTOS_TOKES = {
  1: [ 
    { emoji: "üí™", nombre: "GYM", texto: "que est√°s a üî• en el GYM" },
    { emoji: "üß•", nombre: "OUTFIT", texto: "que tu OUTFIT es üî•" },
    { emoji: "üòé", nombre: "ACTITUD", texto: "que como la LIAS üî•" },
    { emoji: "üéÆ", nombre: "JUGADA", texto: "que tu JUGADA fue üî•" }
  ],
  2: [
    { emoji: "üîç", nombre: "INTERES", texto: "que A ALGUIEN le gustas üíï" },
    { emoji: "üí≠", nombre: "MY SECRET", texto: "que tiene un CRUSH secreto üíï" },
    { emoji: "üéØ", nombre: "MY CRUSH", texto: "que ERES su crush üíï" },
    { emoji: "üòè", nombre: "INDIRECTA", texto: "que te lanza una INDIRECTA üíï" }
  ],
  3: [
    { emoji: "üìö", nombre: "EXAMEN", texto: "te apoya üí™ para el EXAMEN" },
    { emoji: "üè•", nombre: "MEJORATE", texto: "te manda üí™ para que TE MEJORES" },
    { emoji: "üíî", nombre: "RUPTURA", texto: "te da üí™ tras la RUPTURA" },
    { emoji: "üéØ", nombre: "META", texto: "te anima üí™ a cumplir TU META" }
  ],
  4: [
    { emoji: "‚öΩ", nombre: "FUTBOL", texto: "que quiere jugar al ‚öΩ" },
    { emoji: "üçî", nombre: "COMIDA", texto: "que te invita a üçî" },
    { emoji: "üõçÔ∏è", nombre: "COMPRAS", texto: "que quiere ir de üõçÔ∏è" },
    { emoji: "üìÖ", nombre: "QUEDAR", texto: "que quiere quedar üìÖ" }
  ],
  5: [
    { emoji: "üíä", nombre: "DRAMA", texto: "¬°URGENTE: DRAMA üö®!" },
    { emoji: "üé´", nombre: "PLAN", texto: "¬°PLAN de √∫ltimo momento üö®!" },
    { emoji: "üí∏", nombre: "MONEY", texto: "¬°Necesito DINERO üö®!" },
    { emoji: "üÜò", nombre: "AYUDA", texto: "¬°Necesita AYUDA üö®!" }
  ]
};

const COLORES = [
  { hex: '#FF6B9D', name: 'Rosa', shadow: '#FF4785', gradient: ['#FFB8D0', '#FF6B9D', '#FF4785'] },
  { hex: '#4299E1', name: 'Azul', shadow: '#2B6CB0', gradient: ['#90CDF4', '#4299E1', '#2B6CB0'] },
  { hex: '#48BB78', name: 'Verde', shadow: '#276749', gradient: ['#9AE6B4', '#48BB78', '#276749'] },
  { hex: '#ECC94B', name: 'Amarillo', shadow: '#B7791F', gradient: ['#F6E05E', '#ECC94B', '#B7791F'] },
  { hex: '#9F7AEA', name: 'Morado', shadow: '#6B46C1', gradient: ['#D6BCFA', '#9F7AEA', '#6B46C1'] },
  { hex: '#1A202C', name: 'Negro', shadow: '#000000', gradient: ['#4A5568', '#2D3748', '#1A202C'] }
];

const TOKES_TYPES = [
  { id: 1, emoji: 'üî•', name: 'On Fire', desc: '¬°Est√°s imparable!', color: '#E53E3E' },
  { id: 2, emoji: 'üíï', name: 'Crush', desc: 'Pienso en ti', color: '#D53F8C' },
  { id: 3, emoji: 'üí™', name: '√Ånimo', desc: '¬°T√∫ puedes!', color: '#38A169' },
  { id: 4, emoji: 'üìÖ', name: 'Planes', desc: '¬øQuedamos?', color: '#D69E2E' },
  { id: 5, emoji: 'üö®', name: 'Urgente', desc: '¬°Ayuda!', color: '#3182CE' }
];

const EMOJIS_LIST = ['üòä','‚ù§Ô∏è','üëç','üî•','üíØ','ü§•','üëæ','üíï','üöÄ','üéØ','ü¶æ','üôå','üëè','üíã','üêª','üêù','üåà','‚òÄÔ∏è','üåô','‚≠ê','üå∏','üì∏','üöó','üå∑','üçÄ','üçï','üëÖ','üçü','üåÆ','üç∞','üéÇ','üç´','‚òï','ü•§','üèÄ','‚öΩ','üéæ','üèÜ','üéÆ','üé≤','üé∏','üé∫','üé®','üìö','üí°','üîß','üò±','üì±','üíª','üõ∏','ü•∑','üòá','üßü‚Äç‚ôÇÔ∏è','üëΩ','üé©','üßô','üßö','üßú','üíÉüèª','ü¶ã','ü¶Ö','ü¶à','üêÖ','üêò','ü¶í','ü¶è','üåç','üì¶','üè¥‚Äç‚ò†Ô∏è','‚ú®','üö®','üëë','ü¶Ñ','ü¶Å','üßå','ü¶â','üê£','üêâ','üê≤','ü¶ï','ü¶ñ','üåã','üóø','ü™Ñ','‚ö°','üíÄ','üëª','ü§¢','ü§°','üé™','üçæ','üéÜ','üéá','ü´∂','üèÉ‚Äç‚ôÇÔ∏è','üßü‚Äç‚ôÄÔ∏è','ü§ñ','üßä','üòà','üî´','üíÖ','üéê','üéÄ','üéÅ','üé∞','‚úàÔ∏è','ü•µ','ü•∂','‚åöÔ∏è','‚öìÔ∏è','üõÅ','ü™í','ü™§','üí£','üèçÔ∏è','üçí','üå™Ô∏è','üëô','üß©','üç™','üèéÔ∏è','üéì','üß∏','‚úÇÔ∏è','üï≥Ô∏è','‚ù§Ô∏è‚Äçüî•','ü•≥','‚ö∞Ô∏è','üéà','üéâ','üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®','ü¶ä','üí¶','üö™','üéé','‚ö†Ô∏è','üõå','ü§Æ','ü´°','üíé','üõπ','üí∏','üíµ','üíä','üí∂','üéüÔ∏è','‚öúÔ∏è','üí≥','üíø','üìÄ'];

const AVATARES = ['üê±', 'üê∂', 'ü¶ä', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üê∑', 'üê∏', 'üêô', 'ü¶Ñ', 'üê≤'];

const app = {
  state: {
    currentPage: 'splash',
    menuIndex: 0,
    focus: { type: 'splash', index: 0 },
    history: [],
    toquesRestantes: 30,
    selectedCategoria: null,
    selectedVariante: null,
    settings: { sonido: true, vibracion: true, color: 0, avatar: 'üê±' },
    inSelector: false,
    confirmIndex: 0,
    toquesMostrados: new Set()
  },
  
  contactos: {},
  todex: { captured: [], total_toques_enviados: 0, emojis_stats: {} },
  miID: '',
  debugMode: false,

  init() {
    console.log('=== TOKEJI v11 DEBUG ===');
    this.log('Iniciando...');
    
    this.miID = localStorage.getItem("miid");
    if (!this.miID) {
      this.miID = crypto.randomUUID ? crypto.randomUUID().slice(0, 10) : Math.random().toString(36).substring(2, 12);
      localStorage.setItem("miid", this.miID);
    }
    
    try {
      this.contactos = JSON.parse(localStorage.getItem("cts")) || {};
      this.todex = JSON.parse(localStorage.getItem("todex")) || { captured: [], total_toques_enviados: 0, emojis_stats: {} };
      this.state.settings.sonido = localStorage.getItem('sonido') !== 'off';
      this.state.settings.vibracion = localStorage.getItem('vibracion') !== 'off';
      this.state.settings.color = parseInt(localStorage.getItem('colorIndex')) || 0;
      this.state.settings.avatar = localStorage.getItem('avatar') || 'üê±';
      this.state.toquesRestantes = parseInt(localStorage.getItem("toquesRestantes")) || 30;
    } catch(e) {
      this.log('Error cargando datos: ' + e.message);
    }
    
    const hoy = new Date().toDateString();
    const ultima = localStorage.getItem("ultimaFechaToques");
    if (ultima !== hoy) {
      this.state.toquesRestantes = 30;
      localStorage.setItem("toquesRestantes", "30");
      localStorage.setItem("ultimaFechaToques", hoy);
    }
    
    this.applyColor();
    this.updateClock();
    setInterval(() => this.updateClock(), 60000);
    
    // Polling
    setTimeout(() => this.checkIncoming(), 2000);
    setInterval(() => this.checkIncoming(), 8000);
    
    this.log('ID: ' + this.miID);
    this.log('Backend: ' + BACK);
    
    // Debug toggle
    document.getElementById('debug-btn').onclick = () => {
      this.debugMode = !this.debugMode;
      document.getElementById('debug-info').classList.toggle('show', this.debugMode);
    };
    
    this.showPage('splash', false);
  },

  log(msg) {
    console.log(msg);
    const debugEl = document.getElementById('debug-info');
    if (debugEl) {
      debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
      debugEl.scrollTop = debugEl.scrollHeight;
    }
  },

  applyColor() {
    const c = COLORES[this.state.settings.color] || COLORES[0];
    document.documentElement.style.setProperty('--device-color', c.hex);
    document.documentElement.style.setProperty('--device-dark', c.shadow);
    const device = document.getElementById('device');
    if (device) device.style.background = `linear-gradient(145deg, ${c.gradient[0]} 0%, ${c.gradient[1]} 50%, ${c.gradient[2]} 100%)`;
  },

  updateClock() {
    const now = new Date();
    const el = document.getElementById('clock');
    if (el) el.textContent = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  },

  showPage(page, save = true) {
    if (save && this.state.currentPage !== page) this.state.history.push(this.state.currentPage);
    
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const pageEl = document.getElementById('page-' + page);
    if (pageEl) pageEl.classList.add('active');
    
    this.state.currentPage = page;
    this.state.inSelector = false;
    
    switch(page) {
      case 'splash': this.state.focus = { type: 'splash', index: 0 }; break;
      case 'consent': this.state.focus = { type: 'consent', index: 0 }; this.updateConsentFocus(); break;
      case 'setup': this.state.focus = { type: 'setup', index: 0 }; break;
      case 'avatar': this.state.focus = { type: 'avatar', index: 0 }; this.renderAvatarGrid(); this.updateAvatarFocus(); break;
      case 'color': this.state.focus = { type: 'color', index: 0 }; this.renderColorSetupGrid(); this.updateColorSetupFocus(); break;
      case 'menu': this.state.focus = { type: 'menu', index: this.state.menuIndex }; this.updateMenuFocus(); break;
      case 'tokes': this.renderTokes(); this.state.focus = { type: 'tokes', index: 0 }; this.updateTokesFocus(); break;
      case 'variantes': this.renderVariantes(); this.state.focus = { type: 'variantes', index: 0 }; this.updateVariantesFocus(); break;
      case 'enviar': this.renderEnviarList(); this.state.focus = { type: 'enviar', index: 0 }; this.updateEnviarFocus(); break;
      case 'contacts': this.renderContacts(); this.state.focus = { type: 'contacts', index: 0 }; this.updateContactsFocus(); break;
      case 'todox': this.renderTodex(); this.state.focus = { type: 'grid', index: 0 }; this.updateGridFocus(); break;
      case 'settings': this.updateSettingsUI(); this.state.focus = { type: 'settings', index: 0 }; this.updateSettingsFocus(); break;
      case 'test': this.state.focus = { type: 'test', index: 0 }; this.updateTestPage(); break;
      case 'home': this.updateHome(); break;
      case 'qr': this.generarQR(); break;
    }
  },

  updateTestPage() {
    document.getElementById('test-url').textContent = BACK;
    document.getElementById('test-id').textContent = this.miID;
  },

  // ========================================
  // TEST FUNCTIONS
  // ========================================

  async testBackend() {
    this.log('Testing backend...');
    this.showMsg('Testeando...');
    
    try {
      // Test simple GET
      const url = `${BACK}/toques-pendientes?userId=${this.miID}`;
      this.log('GET ' + url);
      
      const response = await fetch(url, {
        method: 'GET',
        headers: { 'Cache-Control': 'no-cache' }
      });
      
      this.log('Status: ' + response.status);
      
      const text = await response.text();
      this.log('Respuesta: ' + text.substring(0, 200));
      
      if (response.ok) {
        this.showMsg('‚úÖ Backend OK!');
      } else {
        this.showMsg('‚ùå Error ' + response.status);
      }
    } catch(e) {
      this.log('ERROR: ' + e.message);
      this.showMsg('‚ùå ' + e.message);
      alert('Error de conexi√≥n:\n' + e.message + '\n\nPosibles causas:\n1. Backend ca√≠do\n2. CORS bloqueado\n3. Sin internet');
    }
  },

  async testEnviarToque() {
    this.log('Test enviar toque...');
    
    const amigos = Object.keys(this.contactos);
    if (amigos.length === 0) {
      alert('Primero agrega un amigo escaneando su QR');
      return;
    }
    
    const paraId = amigos[0];
    const paraNombre = this.contactos[paraId];
    
    this.log('Enviando a: ' + paraNombre);
    
    const payload = {
      de: this.miID,
      para: paraId,
      num: 1,
      contexto: 1
    };
    
    this.log('Payload: ' + JSON.stringify(payload));
    
    try {
      this.showMsg('Enviando...');
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);
      
      const response = await fetch(`${BACK}/toque`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;charset=UTF-8',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload),
        signal: controller.signal,
        mode: 'cors',
        credentials: 'omit'
      });
      
      clearTimeout(timeoutId);
      
      this.log('Status: ' + response.status);
      this.log('Headers: ' + JSON.stringify([...response.headers]));
      
      const responseText = await response.text();
      this.log('Body: ' + responseText);
      
      let data;
      try {
        data = JSON.parse(responseText);
      } catch(e) {
        data = { raw: responseText };
      }
      
      if (response.ok && data.ok) {
        this.showMsg('‚úÖ Test OK! Toque enviado');
        alert('¬°√âXITO!\n\nEl toque se envi√≥ correctamente.\n\nRespuesta del servidor:\n' + JSON.stringify(data, null, 2));
      } else {
        this.showMsg('‚ùå Error ' + response.status);
        alert('ERROR ' + response.status + '\n\n' + (data.error || data.raw || 'Error desconocido'));
      }
    } catch(e) {
      this.log('ERROR FETCH: ' + e.name + ': ' + e.message);
      this.showMsg('‚ùå ' + e.message);
      
      let errorMsg = 'Error: ' + e.message;
      if (e.name === 'TypeError' && e.message.includes('fetch')) {
        errorMsg += '\n\nEsto suele ser problema de CORS.\nEl backend debe permitir tu dominio.';
      } else if (e.name === 'AbortError') {
        errorMsg += '\n\nTimeout - El servidor no responde';
      }
      
      alert(errorMsg);
    }
  },

  // ========================================
  // NAVEGACI√ìN
  // ========================================

  handleConsent(accepted) {
    if (accepted) {
      localStorage.setItem('consent', 'true');
      this.showPage('setup', false);
    } else {
      this.showMsg('Debes aceptar');
    }
  },

  updateConsentFocus() {
    document.querySelectorAll('.consent-btn').forEach((btn, i) => btn.classList.toggle('focused', i === this.state.focus.index));
  },

  renderAvatarGrid() {
    const grid = document.getElementById('avatar-grid');
    if (grid) grid.innerHTML = AVATARES.map((av, i) => `<div class="avatar-item ${i === 0 ? 'focused' : ''}" data-index="${i}">${av}</div>`).join('');
  },

  updateAvatarFocus() {
    document.querySelectorAll('#avatar-grid .avatar-item').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index));
  },

  renderColorSetupGrid() {
    const grid = document.getElementById('color-setup-grid');
    if (grid) grid.innerHTML = COLORES.map((c, i) => `<div class="color-setup-item ${i === 0 ? 'focused' : ''}" style="background: ${c.hex};" data-index="${i}"></div>`).join('');
  },

  updateColorSetupFocus() {
    document.querySelectorAll('#color-setup-grid .color-setup-item').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index));
  },

  goBack() {
    const confirmModal = document.getElementById('confirm-reiniciar');
    if (confirmModal?.classList.contains('active')) { confirmModal.classList.remove('active'); return; }
    
    if (this.state.inSelector) {
      document.querySelectorAll('.selector-modal').forEach(m => m.classList.remove('active'));
      this.state.inSelector = false;
      return;
    }
    
    const toqueModal = document.getElementById('toque-recibido-modal');
    if (toqueModal?.classList.contains('active')) return;

    if (['consent', 'setup', 'avatar', 'color'].includes(this.state.currentPage)) return;
    
    if (this.state.history.length > 0) {
      const prev = this.state.history.pop();
      this.showPage(prev, false);
    } else if (this.state.currentPage !== 'home') {
      this.showPage('home', false);
    }
  },

  handleBack() { this.goBack(); },

  handleOK() {
    const { currentPage, focus } = this.state;
    
    const confirmModal = document.getElementById('confirm-reiniciar');
    if (confirmModal?.classList.contains('active')) {
      this.state.confirmIndex === 0 ? this.cancelarReinicio() : this.confirmarReinicio();
      return;
    }
    
    if (this.state.inSelector) { this.selectFromSelector(); return; }

    switch(currentPage) {
      case 'splash':
        const hasConsent = localStorage.getItem('consent');
        const hasNombre = localStorage.getItem('miNombre');
        if (!hasConsent) this.showPage('consent', false);
        else if (!hasNombre) this.showPage('setup', false);
        else this.showPage('home', false);
        break;
      case 'consent': this.handleConsent(focus.index === 1); break;
      case 'setup':
        const nom = document.getElementById('miNombre').value.trim();
        if (!nom) { this.showMsg('Escribe tu nombre'); return; }
        localStorage.setItem('miNombre', nom);
        this.showPage('avatar', false);
        break;
      case 'avatar':
        this.state.settings.avatar = AVATARES[focus.index];
        localStorage.setItem('avatar', this.state.settings.avatar);
        this.showPage('color', false);
        break;
      case 'color':
        this.state.settings.color = focus.index;
        localStorage.setItem('colorIndex', focus.index);
        this.applyColor();
        this.generarQR();
        this.showPage('home', false);
        break;
      case 'home': this.showPage('menu'); break;
      case 'menu':
        const items = ['tokes', 'contacts', 'qr', 'todox', 'settings', 'test'];
        this.showPage(items[focus.index]);
        break;
      case 'tokes':
        this.state.selectedCategoria = TOKES_TYPES[focus.index].id;
        this.showPage('variantes');
        break;
      case 'variantes':
        const variantes = CONTEXTOS_TOKES[this.state.selectedCategoria];
        this.state.selectedVariante = variantes[focus.index];
        this.showPage('enviar');
        break;
      case 'enviar':
        const amigosList = Object.entries(this.contactos);
        if (focus.index === 0) this.scanQR();
        else if (amigosList[focus.index - 1]) {
          const [id, nombre] = amigosList[focus.index - 1];
          this.enviarToque(id, nombre);
        }
        break;
      case 'contacts': if (focus.index === 0) this.scanQR(); break;
      case 'todox': if (this.todex.captured.includes(focus.index + 1)) this.showEmojiDetail(focus.index + 1); break;
      case 'settings': this.activateSetting(focus.index); break;
    }
  },

  handleUp() {
    const { type, index } = this.state.focus;
    switch(type) {
      case 'avatar': if (index >= 4) { this.state.focus.index -= 4; this.updateAvatarFocus(); } break;
      case 'color': if (index >= 2) { this.state.focus.index -= 2; this.updateColorSetupFocus(); } break;
      case 'menu': if (index >= 2) { this.state.focus.index -= 2; this.state.menuIndex = this.state.focus.index; this.updateMenuFocus(); } break;
      case 'tokes': if (index > 0) { this.state.focus.index--; this.updateTokesFocus(); } break;
      case 'variantes': if (index > 0) { this.state.focus.index--; this.updateVariantesFocus(); } break;
      case 'enviar': if (index > 0) { this.state.focus.index--; this.updateEnviarFocus(); } break;
      case 'contacts': if (index > 0) { this.state.focus.index--; this.updateContactsFocus(); } break;
      case 'grid': if (index >= 5) { this.state.focus.index -= 5; this.updateGridFocus(); } break;
      case 'settings': if (index > 0) { this.state.focus.index--; this.updateSettingsFocus(); } break;
    }
  },

  handleDown() {
    const { type, index } = this.state.focus;
    switch(type) {
      case 'avatar': if (index < 8) { this.state.focus.index = Math.min(index + 4, 11); this.updateAvatarFocus(); } break;
      case 'color': if (index < 4) { this.state.focus.index = Math.min(index + 2, 5); this.updateColorSetupFocus(); } break;
      case 'menu': if (index < 4) { this.state.focus.index = Math.min(index + 2, 5); this.state.menuIndex = this.state.focus.index; this.updateMenuFocus(); } break;
      case 'tokes': if (index < TOKES_TYPES.length - 1) { this.state.focus.index++; this.updateTokesFocus(); } break;
      case 'variantes': 
        const vars = CONTEXTOS_TOKES[this.state.selectedCategoria] || [];
        if (index < vars.length - 1) { this.state.focus.index++; this.updateVariantesFocus(); }
        break;
      case 'enviar': 
        const maxA = Object.keys(this.contactos).length;
        if (index < maxA) { this.state.focus.index++; this.updateEnviarFocus(); }
        break;
      case 'contacts':
        const maxC = Object.keys(this.contactos).length;
        if (index < maxC) { this.state.focus.index++; this.updateContactsFocus(); }
        break;
      case 'grid': if (index < 145) { this.state.focus.index += 5; this.updateGridFocus(); } break;
      case 'settings': if (index < 3) { this.state.focus.index++; this.updateSettingsFocus(); } break;
    }
  },

  handleLeft() {
    const { type, index } = this.state.focus;
    switch(type) {
      case 'consent': this.state.focus.index = 0; this.updateConsentFocus(); break;
      case 'avatar': if (index % 4 > 0) { this.state.focus.index--; this.updateAvatarFocus(); } break;
      case 'color': if (index % 2 > 0) { this.state.focus.index--; this.updateColorSetupFocus(); } break;
      case 'menu': if (index % 2 !== 0) { this.state.focus.index--; this.state.menuIndex = this.state.focus.index; this.updateMenuFocus(); } break;
      case 'grid': if (index % 5 > 0) { this.state.focus.index--; this.updateGridFocus(); } break;
    }
  },

  handleRight() {
    const { type, index } = this.state.focus;
    switch(type) {
      case 'consent': this.state.focus.index = 1; this.updateConsentFocus(); break;
      case 'avatar': if (index % 4 < 3 && index < 11) { this.state.focus.index++; this.updateAvatarFocus(); } break;
      case 'color': if (index % 2 === 0 && index < 5) { this.state.focus.index++; this.updateColorSetupFocus(); } break;
      case 'menu': if (index % 2 === 0 && index < 5) { this.state.focus.index++; this.state.menuIndex = this.state.focus.index; this.updateMenuFocus(); } break;
      case 'grid': if (index % 5 < 4 && index < 149) { this.state.focus.index++; this.updateGridFocus(); } break;
    }
  },

  updateMenuFocus() { document.querySelectorAll('.menu-item').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index)); },
  updateTokesFocus() { document.querySelectorAll('#tokes-list .toke-item').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index)); },
  updateVariantesFocus() { document.querySelectorAll('#variantes-list .variante-item').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index)); },
  updateEnviarFocus() { document.querySelectorAll('#enviar-list .list-item').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index)); },
  updateContactsFocus() {
    const scanBtn = document.getElementById('scan-btn');
    const items = document.querySelectorAll('#contacts-list .list-item');
    if (scanBtn) scanBtn.classList.toggle('focused', this.state.focus.index === 0);
    items.forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index - 1));
  },
  updateGridFocus() { document.querySelectorAll('.emoji-card').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index)); },
  updateSettingsFocus() { document.querySelectorAll('.setting-item').forEach((el, i) => el.classList.toggle('focused', i === this.state.focus.index)); },

  renderTokes() {
    const container = document.getElementById('tokes-list');
    if (container) container.innerHTML = TOKES_TYPES.map((t, i) => `
      <div class="toke-item t${t.id} ${i === 0 ? 'focused' : ''}" data-index="${i}">
        <span style="font-size: 26px;">${t.emoji}</span>
        <div style="flex: 1;"><div style="font-weight: 800; color: ${t.color}; font-size: 14px;">${t.name}</div><div style="font-size: 11px; color: #718096;">${t.desc}</div></div>
        <span style="font-size: 10px; background: #EDF2F7; padding: 2px 6px; border-radius: 10px;">4</span>
      </div>
    `).join('');
  },

  renderVariantes() {
    const container = document.getElementById('variantes-list');
    const title = document.getElementById('variantes-title');
    if (!container || !title) return;
    const categoria = TOKES_TYPES.find(t => t.id === this.state.selectedCategoria);
    const variantes = CONTEXTOS_TOKES[this.state.selectedCategoria] || [];
    title.textContent = `${categoria?.emoji || 'üíå'} ${categoria?.name || 'Toque'}`;
    container.innerHTML = variantes.map((v, i) => `
      <div class="variante-item v${this.state.selectedCategoria} ${i === 0 ? 'focused' : ''}" data-index="${i}">
        <span style="font-size: 26px;">${v.emoji}</span>
        <div style="flex: 1;"><div style="font-weight: 800; font-size: 14px;">${v.nombre}</div><div style="font-size: 10px; color: #718096;">${v.texto}</div></div>
      </div>
    `).join('');
  },

  renderEnviarList() {
    const container = document.getElementById('enviar-list');
    const info = document.getElementById('toke-seleccionado');
    if (!container || !info) return;
    const categoria = TOKES_TYPES.find(t => t.id === this.state.selectedCategoria);
    const variante = this.state.selectedVariante;
    if (categoria && variante) info.innerHTML = `${categoria.emoji} ${variante.nombre}`;
    
    const amigos = Object.entries(this.contactos);
    let html = `<div class="list-item focused" data-index="0"><span style="font-size: 26px;">üì∑</span><div style="flex: 1;"><div style="font-weight: 800; color: #805AD5;">Escanear QR</div></div></div>`;
    if (amigos.length === 0) html += `<div style="text-align: center; color: #A0AEC0; padding: 25px;">No tienes amigos</div>`;
    else html += amigos.map(([id, nom], i) => `
      <div class="list-item" data-index="${i + 1}">
        <span style="font-size: 26px;">üë§</span>
        <div style="flex: 1;"><div style="font-weight: 800;">${nom}</div><div style="font-size: 9px; color: #A0AEC0;">${id.substring(0, 10)}...</div></div>
        <button class="btn-eliminar" onclick="event.stopPropagation(); app.eliminarAmigo('${id}')">‚úï</button>
      </div>
    `).join('');
    container.innerHTML = html;
  },

  eliminarAmigo(id) {
    if (confirm('¬øEliminar?')) {
      delete this.contactos[id];
      localStorage.setItem('cts', JSON.stringify(this.contactos));
      this.renderEnviarList();
      this.renderContacts();
      this.showMsg('Eliminado');
    }
  },

  renderContacts() {
    const container = document.getElementById('contacts-list');
    if (!container) return;
    const lista = Object.entries(this.contactos);
    if (lista.length === 0) container.innerHTML = '<div style="text-align: center; color: #A0AEC0; padding: 35px;">No tienes amigos</div>';
    else container.innerHTML = lista.map(([id, nom], i) => `
      <div class="list-item" data-index="${i}">
        <span style="font-size: 26px;">üë§</span>
        <div style="flex: 1;"><div style="font-weight: 800;">${nom}</div><div style="font-size: 9px; color: #A0AEC0;">${id.substring(0, 10)}...</div></div>
        <button class="btn-eliminar" onclick="event.stopPropagation(); app.eliminarAmigo('${id}')">‚úï</button>
      </div>
    `).join('');
  },

  renderTodex() {
    const grid = document.getElementById('todex-grid');
    const count = document.getElementById('todex-count');
    if (!grid || !count) return;
    count.textContent = `${this.todex.captured.length}/150`;
    grid.innerHTML = Array(150).fill(0).map((_, i) => {
      const captured = this.todex.captured.includes(i+1);
      return `<div class="emoji-card ${captured ? 'captured' : ''} ${i === 0 ? 'focused' : ''}" data-index="${i}">${captured ? (EMOJIS_LIST[i] || '‚ú®') : '‚Ä¢'}</div>`;
    }).join('');
  },

  updateHome() {
    const nom = localStorage.getItem('miNombre') || 'Amigo';
    const nameEl = document.getElementById('home-name');
    const badgeEl = document.getElementById('tokes-badge');
    const avatarEl = document.getElementById('home-avatar');
    if (nameEl) nameEl.textContent = nom;
    if (badgeEl) badgeEl.textContent = `üéØ ${this.state.toquesRestantes}/30`;
    if (avatarEl) avatarEl.textContent = this.state.settings.avatar;
  },

  updateSettingsUI() {
    const sonidoEl = document.getElementById('toggle-sonido');
    const vibraEl = document.getElementById('toggle-vibra');
    const colorEl = document.getElementById('color-preview');
    if (sonidoEl) sonidoEl.classList.toggle('active', this.state.settings.sonido);
    if (vibraEl) vibraEl.classList.toggle('active', this.state.settings.vibracion);
    const c = COLORES[this.state.settings.color];
    if (colorEl && c) colorEl.style.background = c.hex;
  },

  activateSetting(index) {
    switch(index) {
      case 0: this.state.settings.sonido = !this.state.settings.sonido; localStorage.setItem('sonido', this.state.settings.sonido ? 'on' : 'off'); this.showMsg(this.state.settings.sonido ? 'üîä ON' : 'üîá OFF'); this.updateSettingsUI(); break;
      case 1: this.state.settings.vibracion = !this.state.settings.vibracion; localStorage.setItem('vibracion', this.state.settings.vibracion ? 'on' : 'off'); this.showMsg(this.state.settings.vibracion ? 'üì≥ ON' : 'üì≥ OFF'); this.updateSettingsUI(); break;
      case 2: this.showColorSelector(); break;
      case 3: this.mostrarConfirmReinicio(); break;
    }
  },

  mostrarConfirmReinicio() { this.state.confirmIndex = 0; document.getElementById('confirm-reiniciar').classList.add('active'); },

  cancelarReinicio() { document.getElementById('confirm-reiniciar').classList.remove('active'); },

  confirmarReinicio() { localStorage.clear(); location.reload(); },

  showColorSelector() {
    this.state.inSelector = true;
    this.state.selectorIndex = this.state.settings.color;
    const modal = document.getElementById('color-selector');
    const grid = document.getElementById('color-grid');
    if (grid) grid.innerHTML = COLORES.map((c, i) => `<div class="selector-item ${i === this.state.selectorIndex ? 'focused' : ''}" style="background: ${c.hex};" data-index="${i}"><div style="width: 35px; height: 35px; border-radius: 50%; background: ${c.hex}; border: 3px solid white;"></div><span style="margin-top: 6px; font-size: 11px;">${c.name}</span></div>`).join('');
    if (modal) modal.classList.add('active');
  },

  selectFromSelector() {
    this.state.settings.color = this.state.selectorIndex;
    localStorage.setItem('colorIndex', this.state.selectorIndex);
    this.applyColor();
    document.querySelectorAll('.selector-modal').forEach(m => m.classList.remove('active'));
    this.state.inSelector = false;
    this.updateSettingsUI();
  },

  generarQR() {
    const nom = localStorage.getItem('miNombre') || 'Amigo';
    const texto = `${this.miID}|${nom}`;
    const qrDiv = document.getElementById('qr-mio');
    if (qrDiv) qrDiv.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(texto)}" style="width: 140px; height: 140px;"/>`;
  },

  async scanQR() {
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      this.inputManualQR();
      return;
    }
    
    let stream = null;
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;';
    modal.innerHTML = `<div style="color:white;font-size:18px;margin-bottom:20px;">üì∑ Escaneando...</div><video id="scan-video" style="width:260px;height:260px;border-radius:16px;background:#000;" autoplay playsinline></video><button onclick="this.parentElement.remove()" style="margin-top:20px;padding:10px 20px;background:#F56565;color:white;border:none;border-radius:20px;">Cancelar</button>`;
    document.body.appendChild(modal);
    
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      const video = document.getElementById('scan-video');
      video.srcObject = stream;
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const scan = setInterval(() => {
        if (!document.getElementById('scan-video')) { clearInterval(scan); return; }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        
        if (code?.data) {
          clearInterval(scan);
          stream.getTracks().forEach(t => t.stop());
          modal.remove();
          this.procesarQR(code.data);
        }
      }, 200);
    } catch(err) {
      this.log('Camera error: ' + err.message);
      modal.remove();
      this.inputManualQR();
    }
  },

  inputManualQR() {
    const codigo = prompt('Pega c√≥digo (ID|Nombre):');
    if (codigo?.trim()) this.procesarQR(codigo.trim());
  },

  procesarQR(data) {
    this.log('Procesando: ' + data);
    const parts = data.split('|');
    if (parts.length >= 2) {
      const [id, nombre] = parts;
      if (id && nombre && id !== this.miID) {
        this.contactos[id] = nombre;
        localStorage.setItem('cts', JSON.stringify(this.contactos));
        this.showMsg(`‚úÖ ${nombre} agregado`);
        if (this.state.currentPage === 'enviar') this.renderEnviarList();
        else if (this.state.currentPage === 'contacts') this.renderContacts();
        return;
      }
    }
    this.showMsg('‚ùå QR inv√°lido');
  },

  // ========================================
  // ENV√çO DE TOQUES - VERSI√ìN ROBUSTA
  // ========================================

  async enviarToque(paraId, paraNombre) {
    this.log('=== ENVIANDO TOQUE ===');
    this.log('Para: ' + paraId + ' / ' + paraNombre);
    
    if (!this.state.selectedVariante || !this.state.selectedCategoria) {
      this.showMsg('Error: No hay toque seleccionado');
      return;
    }
    
    if (this.state.toquesRestantes <= 0) {
      this.showMsg('‚ùå Sin tokes');
      return;
    }
    
    const variantes = CONTEXTOS_TOKES[this.state.selectedCategoria];
    const contextoIndex = variantes.findIndex(v => v.nombre === this.state.selectedVariante.nombre) + 1;
    
    const payload = {
      de: this.miID,
      para: paraId,
      num: this.state.selectedCategoria,
      contexto: contextoIndex
    };
    
    this.log('Payload: ' + JSON.stringify(payload));
    this.showMsg('Enviando...');
    
    // Intentar con XMLHttpRequest primero (m√°s compatible)
    try {
      const result = await this.sendWithXHR(payload);
      this.handleSendSuccess(result, paraNombre);
    } catch(xhrError) {
      this.log('XHR failed, trying fetch: ' + xhrError);
      // Fallback a fetch
      try {
        const result = await this.sendWithFetch(payload);
        this.handleSendSuccess(result, paraNombre);
      } catch(fetchError) {
        this.log('FETCH ERROR: ' + fetchError.message);
        this.showMsg('‚ùå Error de red');
        alert('Error al enviar:\n' + fetchError.message + '\n\nRevisa la consola (F12) para m√°s detalles.');
      }
    }
  },

  sendWithXHR(payload) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', `${BACK}/toque`, true);
      xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
      xhr.setRequestHeader('Accept', 'application/json');
      
      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            resolve(JSON.parse(xhr.responseText));
          } catch(e) {
            resolve({ ok: true, raw: xhr.responseText });
          }
        } else {
          reject(new Error('HTTP ' + xhr.status + ': ' + xhr.responseText));
        }
      };
      
      xhr.onerror = () => reject(new Error('Network Error (XHR)'));
      xhr.ontimeout = () => reject(new Error('Timeout'));
      xhr.timeout = 10000;
      
      xhr.send(JSON.stringify(payload));
    });
  },

  async sendWithFetch(payload) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const response = await fetch(`${BACK}/toque`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json;charset=UTF-8',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload),
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit'
    });
    
    clearTimeout(timeoutId);
    
    const text = await response.text();
    this.log('Response: ' + response.status + ' - ' + text.substring(0, 100));
    
    if (!response.ok) throw new Error('HTTP ' + response.status);
    
    try {
      return JSON.parse(text);
    } catch(e) {
      return { ok: true, raw: text };
    }
  },

  handleSendSuccess(data, paraNombre) {
    this.log('Success: ' + JSON.stringify(data));
    
    if (data.toques_restantes !== undefined) {
      this.state.toquesRestantes = data.toques_restantes;
      localStorage.setItem('toquesRestantes', this.state.toquesRestantes);
    } else {
      this.state.toquesRestantes--;
      localStorage.setItem('toquesRestantes', this.state.toquesRestantes);
    }
    
    this.updateHome();
    this.todex.total_toques_enviados++;
    localStorage.setItem('todex', JSON.stringify(this.todex));
    
    if (this.todex.total_toques_enviados % 5 === 0) {
      this.verificarDesbloqueos();
    }
    
    this.showMsg(`‚úÖ Enviado a ${paraNombre}`);
    this.state.selectedCategoria = null;
    this.state.selectedVariante = null;
    
    setTimeout(() => this.showPage('home'), 2000);
  },

  verificarDesbloqueos() {
    const disponibles = [];
    for (let i = 1; i <= 150; i++) if (!this.todex.captured.includes(i)) disponibles.push(i);
    if (disponibles.length > 0) {
      const nuevo = disponibles[Math.floor(Math.random() * disponibles.length)];
      this.todex.captured.push(nuevo);
      localStorage.setItem('todex', JSON.stringify(this.todex));
      const emoji = EMOJIS_LIST[nuevo - 1] || '‚ú®';
      this.showMsg(`üéâ ¬°${emoji} #${nuevo}!`);
    }
  },

  // ========================================
  // RECEPCI√ìN DE TOQUES
  // ========================================

  async checkIncoming() {
    if (['splash', 'setup', 'consent'].includes(this.state.currentPage)) return;
    
    try {
      const response = await fetch(`${BACK}/toques-pendientes?userId=${this.miID}`, {
        method: 'GET',
        headers: { 'Cache-Control': 'no-cache' }
      });
      
      if (!response.ok) return;
      
      const data = await response.json();
      this.log('Check incoming: ' + JSON.stringify(data).substring(0, 100));
      
      if (data?.ok && data.toques?.length > 0) {
        data.toques.forEach((toque, i) => {
          setTimeout(() => this.mostrarToqueRecibido(toque), i * 1500);
        });
      }
    } catch(e) {
      // Silenciar errores de polling
    }
  },

  mostrarToqueRecibido(toque) {
    const hoy = new Date().toDateString();
    const idUnico = `${hoy}-${toque.de}-${toque.num}-${toque.hora || Date.now()}`;
    if (this.state.toquesMostrados.has(idUnico)) return;
    this.state.toquesMostrados.add(idUnico);
    
    const nombre = this.contactos[toque.de] || 'Alguien';
    const categoria = TOKES_TYPES.find(t => t.id === toque.num) || TOKES_TYPES[0];
    
    let mensajeTexto = `¬°${nombre} te dio un Toque!`;
    if (toque.contexto && CONTEXTOS_TOKES[toque.num]) {
      const ctx = CONTEXTOS_TOKES[toque.num][parseInt(toque.contexto) - 1];
      if (ctx) mensajeTexto = `¬°${nombre} dice ${ctx.texto}!`;
    }
    
    const modal = document.getElementById('toque-recibido-modal');
    const emojiEl = document.getElementById('toque-emoji');
    const nombreEl = document.getElementById('toque-nombre');
    const mensajeEl = document.getElementById('toque-mensaje');
    
    if (modal && emojiEl && nombreEl && mensajeEl) {
      emojiEl.textContent = categoria.emoji;
      nombreEl.textContent = nombre;
      mensajeEl.textContent = mensajeTexto;
      modal.classList.add('active');
      if (this.state.settings.vibracion && navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }
  },

  cerrarToqueRecibido() {
    const modal = document.getElementById('toque-recibido-modal');
    if (modal) modal.classList.remove('active');
  },

  showEmojiDetail(id) {
    const emoji = EMOJIS_LIST[id-1] || '‚ú®';
    this.showMsg(`${emoji} #${id}`);
  },

  showMsg(text) {
    const bar = document.getElementById('msg-bar');
    if (bar) {
      bar.textContent = text;
      bar.classList.add('show');
      setTimeout(() => bar.classList.remove('show'), 3000);
    }
  }
};

window.addEventListener('load', () => app.init());
</script>
</body>
</html>
